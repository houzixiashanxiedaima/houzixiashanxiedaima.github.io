<!DOCTYPE html><html lang="zh-CN" data-astro-cid-sckkx6r4> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v5.17.1"><meta name="description" content="由我撰写，由大型语言模型校对。详情见文末。"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self'; font-src 'self' data:;"><link rel="canonical" href="https://blog.yuyins.com/reading-list/when-compilers-surprise-you-31rprr/"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://blog.yuyins.com/reading-list/when-compilers-surprise-you-31rprr/"><meta property="og:title" content="编译器偶尔会给你惊喜"><meta property="og:description" content="由我撰写，由大型语言模型校对。详情见文末。"><meta property="og:image" content="https://blog.yuyins.com/favicon.svg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://blog.yuyins.com/reading-list/when-compilers-surprise-you-31rprr/"><meta property="twitter:title" content="编译器偶尔会给你惊喜"><meta property="twitter:description" content="由我撰写，由大型语言模型校对。详情见文末。"><meta property="twitter:image" content="https://blog.yuyins.com/favicon.svg"><title>编译器偶尔会给你惊喜</title><!-- Theme and color scheme script (runs before page loads to prevent flash) --><script>
			// 初始化配色方案 - 默认使用 stone-amber
			const colorScheme = localStorage.getItem('colorScheme') || 'stone-amber';
			document.documentElement.setAttribute('data-color', colorScheme);

			// 强制使用浅色主题
			document.documentElement.setAttribute('data-theme', 'light');
		</script><link rel="stylesheet" href="/_astro/_slug_.85a8WIJw.css">
<style>.blog-post-container[data-astro-cid-wrgicudb]{width:100%;margin:0 auto;padding:2rem 0}.blog-post[data-astro-cid-wrgicudb]{width:100%;min-width:0;max-width:42rem;margin:0 auto}.article-header[data-astro-cid-wrgicudb]{margin-bottom:2rem;padding-bottom:1rem;border-bottom:1px solid var(--border)}.article-header[data-astro-cid-wrgicudb] h1[data-astro-cid-wrgicudb]{font-size:2rem;line-height:1.3;margin-bottom:1rem;font-weight:700;color:var(--foreground);word-break:break-word}.article-meta[data-astro-cid-wrgicudb]{display:flex;align-items:center;gap:.5rem;font-size:.875rem;color:var(--muted-foreground)}.source-tag[data-astro-cid-wrgicudb]{background-color:var(--muted);color:var(--foreground);padding:.125rem .5rem;border-radius:9999px;font-weight:500;font-size:.75rem;text-decoration:none;transition:opacity .2s}.source-tag[data-astro-cid-wrgicudb]:hover{opacity:.8}.separator[data-astro-cid-wrgicudb]{color:var(--border)}.article-content[data-astro-cid-wrgicudb]{line-height:1.8;margin-bottom:3rem;font-size:1.0625rem;color:var(--foreground)}.article-content[data-astro-cid-wrgicudb] h2{margin-top:2rem;margin-bottom:1rem;font-size:1.5rem;font-weight:600}.article-content[data-astro-cid-wrgicudb] h3{margin-top:1.5rem;margin-bottom:.75rem;font-size:1.25rem;font-weight:600}.article-content[data-astro-cid-wrgicudb] p{margin-bottom:1.25rem}.article-content[data-astro-cid-wrgicudb] a{color:var(--accent);text-decoration:underline;text-underline-offset:2px}.article-content[data-astro-cid-wrgicudb] img{max-width:100%;height:auto;border-radius:.5rem;margin:1.5rem 0}.article-content[data-astro-cid-wrgicudb] blockquote{border-left:4px solid var(--border);padding-left:1rem;margin:1.5rem 0;color:var(--muted-foreground);font-style:italic}.article-content[data-astro-cid-wrgicudb] pre{background:var(--muted);padding:1rem;border-radius:.5rem;overflow-x:auto;font-family:monospace;margin:1.5rem 0}.article-content[data-astro-cid-wrgicudb] ul,.article-content[data-astro-cid-wrgicudb] ol{padding-left:1.5rem;margin-bottom:1.25rem}.article-content[data-astro-cid-wrgicudb] li{margin-bottom:.5rem}.article-footer[data-astro-cid-wrgicudb]{padding-top:2rem;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:1.5rem;align-items:center}.action-row[data-astro-cid-wrgicudb]{display:flex;justify-content:center}.read-original-btn[data-astro-cid-wrgicudb]{display:inline-flex;align-items:center;gap:.5rem;padding:.75rem 1.5rem;background-color:var(--foreground);color:var(--background);border-radius:.5rem;font-weight:500;text-decoration:none;transition:opacity .2s}.read-original-btn[data-astro-cid-wrgicudb]:hover{opacity:.9}.back-to-list[data-astro-cid-wrgicudb]{text-align:center}.back-link[data-astro-cid-wrgicudb]{color:var(--muted-foreground);text-decoration:none;font-size:.875rem;transition:color .2s}.back-link[data-astro-cid-wrgicudb]:hover{color:var(--foreground)}
</style></head> <body data-astro-cid-sckkx6r4> <a id="skip-to-content" href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:px-4 focus:py-2 focus:bg-accent focus:text-background" data-astro-cid-sckkx6r4>Skip to content</a> <header class="header" data-astro-cid-3ef6ksr2> <nav class="header-nav" aria-label="Main navigation" data-astro-cid-3ef6ksr2> <a href="/" class="header-logo" data-astro-cid-3ef6ksr2>
AstroBlog
</a> <div class="header-links" data-astro-cid-3ef6ksr2> <ul class="nav-list" data-astro-cid-3ef6ksr2> <li data-astro-cid-3ef6ksr2> <a href="/" class="nav-link" data-astro-prefetch="true" data-astro-cid-3ef6ksr2> 文章 </a> </li><li data-astro-cid-3ef6ksr2> <a href="/category" class="nav-link" data-astro-prefetch="true" data-astro-cid-3ef6ksr2> 分类 </a> </li><li data-astro-cid-3ef6ksr2> <a href="/reading-list" class="nav-link" data-astro-prefetch="true" data-astro-cid-3ef6ksr2> 订阅 </a> </li><li data-astro-cid-3ef6ksr2> <a href="/about" class="nav-link" data-astro-prefetch="true" data-astro-cid-3ef6ksr2> 关于 </a> </li> </ul> <div class="header-actions" data-astro-cid-3ef6ksr2> <div id="search" data-astro-cid-otpdt6jm> <button id="search-button" class="search-toggle" aria-label="打开搜索" title="搜索 (⌘K)" data-astro-cid-otpdt6jm> <svg class="search-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-astro-cid-otpdt6jm> <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2" stroke-linecap="round" data-astro-cid-otpdt6jm></circle> <path d="M20 20L16.5 16.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" data-astro-cid-otpdt6jm></path> </svg> </button> <dialog id="search-dialog" class="search-modal" data-astro-cid-otpdt6jm> <div class="modal-content" data-astro-cid-otpdt6jm> <div class="modal-header" data-astro-cid-otpdt6jm> <h2 class="modal-title" data-astro-cid-otpdt6jm>搜索文章</h2> <button id="close-search" class="close-button" aria-label="关闭搜索" data-astro-cid-otpdt6jm> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-astro-cid-otpdt6jm> <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-astro-cid-otpdt6jm></path> </svg> </button> </div> <div id="pagefind-ui" data-astro-cid-otpdt6jm></div> </div> </dialog> </div> <script type="module">let d=!1;const c="pagefind-loaded";async function l(t=0){if(sessionStorage.getItem(c)==="true")return g(),!0;const r=document.getElementById("pagefind-ui");if(!r)return!1;r.innerHTML='<div style="padding: 2rem; text-align: center; color: var(--muted-foreground);">加载中...</div>';try{return await new Promise((o,s)=>{const a=document.createElement("script");a.src="/pagefind/pagefind-ui.js",a.onload=o,a.onerror=s,document.head.appendChild(a)}),g(),sessionStorage.setItem(c,"true"),!0}catch(i){return console.error("Failed to load search:",i),t<2?(console.log(`Retrying search load... (${t+1}/2)`),await new Promise(o=>setTimeout(o,1e3)),l(t+1)):(r&&(r.innerHTML=`
          <div style="padding: 2rem; text-align: center;">
            <p style="color: var(--muted-foreground); margin-bottom: 1rem;">搜索功能加载失败</p>
            <button id="retry-search" style="padding: 0.5rem 1rem; background: var(--accent); color: var(--accent-foreground); border: none; border-radius: 0.375rem; cursor: pointer;">
              重试
            </button>
          </div>
        `,document.getElementById("retry-search")?.addEventListener("click",()=>{sessionStorage.removeItem(c),l(0)})),!1)}}function g(){typeof PagefindUI<"u"&&(new PagefindUI({element:"#pagefind-ui",showSubResults:!0,showImages:!1,excerptLength:15,translations:{placeholder:"搜索文章...",clear_search:"清除",load_more:"加载更多",search_label:"搜索此站点",filters_label:"筛选",zero_results:"未找到结果 [SEARCH_TERM]",many_results:"找到 [COUNT] 个结果 [SEARCH_TERM]",one_result:"找到 [COUNT] 个结果 [SEARCH_TERM]",alt_search:"未找到 [SEARCH_TERM] 的结果。显示 [DIFFERENT_TERM] 的结果",search_suggestion:"未找到 [SEARCH_TERM] 的结果。尝试以下搜索：",searching:"搜索中 [SEARCH_TERM]..."}}),setTimeout(()=>{const t=document.querySelector(".pagefind-ui__search-input");t instanceof HTMLElement&&t.focus()},100))}function u(){if(d)return;d=!0;const t=document.getElementById("search-button"),n=document.getElementById("search-dialog"),r=document.getElementById("close-search");if(!t||!n||!r)return;let i=sessionStorage.getItem(c)==="true";const o=async()=>{n.showModal(),document.body.style.overflow="hidden",i?setTimeout(()=>{const e=document.querySelector(".pagefind-ui__search-input");e instanceof HTMLElement&&e.focus()},100):await l()&&(i=!0)},s=()=>{n.close(),document.body.style.overflow=""},a=e=>{e.target===n&&s()},m=e=>{e.key==="Escape"&&n.open&&s()},f=e=>{(e.metaKey||e.ctrlKey)&&e.key==="k"&&(e.preventDefault(),n.open?s():o())};t.addEventListener("click",o),r.addEventListener("click",s),n.addEventListener("click",a),document.addEventListener("keydown",m),document.addEventListener("keydown",f),document.addEventListener("astro:before-swap",()=>{t.removeEventListener("click",o),r.removeEventListener("click",s),n.removeEventListener("click",a),document.removeEventListener("keydown",m),document.removeEventListener("keydown",f),d=!1},{once:!0})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",u):u();document.addEventListener("astro:page-load",u);</script> <link href="/pagefind/pagefind-ui.css" rel="stylesheet">  </div> </div> </nav> </header>  <main id="main-content" data-pagefind-body class="main-content main-content--wide" data-astro-cid-sckkx6r4>  <div class="blog-post-container" data-astro-cid-wrgicudb> <article class="blog-post" data-astro-cid-wrgicudb> <header class="article-header" data-astro-cid-wrgicudb> <h1 data-astro-cid-wrgicudb>编译器偶尔会给你惊喜</h1> <div class="article-meta" data-astro-cid-wrgicudb> <a href="https://xania.org" target="_blank" rel="noopener noreferrer" class="source-tag" data-astro-cid-wrgicudb>xania.org</a> <span class="separator" data-astro-cid-wrgicudb>·</span> <time data-astro-cid-wrgicudb>2025年12月24日</time> </div> </header> <!-- 使用清洗后的安全 HTML 内容 --> <div class="article-content app-prose" data-astro-cid-wrgicudb><div><div><p>Written by me, proof-read by an LLM.
Details at end.<br /></p><p>Every now and then a compiler will surprise me with a really smart trick. When I first saw this optimisation I could hardly believe it. I was looking at loop optimisation, and wrote something like this simple function that sums all the numbers up to a given value:</p><p>So far so decent: GCC has done some preliminary checks, then fallen into a loop that efficiently sums numbers using  (we've ). But taking a closer look at the loop we see something unusual:<code>lea</code><a href="/202512/02-adding-integers" target="_blank" rel="noopener noreferrer">seen this before</a></p><p>The compiler has cleverly realised it can do two numbers at a time using the fact it can see we're going to add   , which is the same as adding . Very cunning, I think you'll agree!<sup><a href="#fn:check" target="_blank" rel="noopener noreferrer">1</a></sup><code>x</code><code>x + 1</code><code>x*2 + 1</code><em>and</em></p><p>If you turn the optimiser up to  you'll see the compiler works even harder to vectorise the loop using parallel adds. All very clever.<code>-O3</code></p><p>This is all for GCC. Let's see what clang does with our code:</p><p>This is where I nearly fell off my chair: ! Clang checks for positive , and if so it does:<strong>there is no loop</strong><code>value</code></p><p>It was not at all obvious to me what on earth was going on here. By backing out the maths a little, this is equivalent to:</p><p>Expanding the parentheses:</p><p>Rearranging a bit:</p><p>Multiplying the  by 2 / 2:<code>(v - 1)</code></p><p>Combining those and cancelling:</p><p>Simplifying and factoring gives us  which is the closed-form solution to the "sum of integers"! Truly amazing - we've gone from an O(n) algorithm as written, to an O(1) one!<code>v(v - 1) / 2</code><sup><a href="#fn:why" target="_blank" rel="noopener noreferrer">2</a></sup></p><p>I love that despite working with compilers for more than twenty years, they can still surprise and delight me. The years of experience and work that have been poured into making compilers great is truly humbling, and inspiring.</p><p>We're nearly at the end of this series - there's so much more to say but that will have to wait for another time. Tomorrow will be a little different: see you then!</p><p><em>See  that accompanies this post.<a href="https://youtu.be/V9dy34slaxA" target="_blank" rel="noopener noreferrer">the video</a></em></p><p><em>This post is day 24 of ,
a 25-day series exploring how compilers transform our code.<a href="/AoCO2025-archive" target="_blank" rel="noopener noreferrer">Advent of Compiler Optimisations 2025</a></em></p><p><em>←  |  →<a href="/202512/23-switching-it-up" target="_blank" rel="noopener noreferrer">Switching it up a bit</a><a href="/202512/25-thank-you" target="_blank" rel="noopener noreferrer">Thank you</a></em></p><p><em>This post was written by a human () and reviewed and proof-read by LLMs and humans.<a href="/MattGodbolt" target="_blank" rel="noopener noreferrer">Matt Godbolt</a></em></p><p>.<em>Support Compiler Explorer on 
or ,
or by buying CE products in the <a href="https://patreon.com/c/mattgodbolt" target="_blank" rel="noopener noreferrer">Patreon</a><a href="https://github.com/sponsors/compiler-explorer" target="_blank" rel="noopener noreferrer">GitHub</a><a href="https://shop.compiler-explorer.com" target="_blank" rel="noopener noreferrer">Compiler Explorer Shop</a></em></p><div><pre><span><code><span>.L3:</span><span><span>lea</span><span><span>edx</span><span>,</span><span><span>[</span><span>rdx</span><span>+</span><span>1</span><span>+</span><span>rax</span><span>*</span><span>2</span><span>]</span><span><span>; result = result + 1 + x*2</span><span><span>add</span><span><span>eax</span><span>,</span><span><span>2</span><span><span>; x += 2</span><span><span>cmp</span><span><span>edi</span><span>,</span><span><span>eax</span><span><span>; x != value</span><span><span>jne</span><span><span>.L3</span><span><span>; keep looping</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></code></span></pre></div><div><pre><span><code><span><span>lea</span><span><span>eax</span><span>,</span><span><span>[</span><span>rdi</span><span><span>-</span><span><span>1</span><span>]</span><span><span>; eax = value - 1</span><span><span>lea</span><span><span>ecx</span><span>,</span><span><span>[</span><span>rdi</span><span><span>-</span><span><span>2</span><span>]</span><span><span>; ecx = value - 2</span><span><span>imul</span><span><span>rcx</span><span>,</span><span><span>rax</span><span><span>; rcx = (value - 1) * (value - 2)</span><span><span>shr</span><span><span>rcx</span><span><span>; rcx &gt;&gt;= 1</span><span><span>lea</span><span><span>eax</span><span>,</span><span><span>[</span><span>rdi</span><span><span>+</span><span><span>rcx</span><span>]</span><span><span>; eax = value + rcx</span><span><span>dec</span><span><span>eax</span><span><span>; --eax</span><span><span>ret</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></code></span></pre></div><div><pre><span><code>v + ((v - 1)(v - 2) / 2) - 1;
</code></span></pre></div><div><pre><span><code>v + (v² - 2v - v + 2) / 2 - 1
</code></span></pre></div><div><pre><span><code>(v² - 3v + 2) / 2 + (v - 1)
</code></span></pre></div><div><pre><span><code>(v² - 3v + 2) / 2 + (2v - 2)/2
</code></span></pre></div><div><pre><span><code>(v² - v) / 2
</code></span></pre></div><div><hr /><ol><li><p>Some of the initial code checks for odd/even and accounts accordingly. <a href="#fnref:check" target="_blank" rel="noopener noreferrer">↩</a></p></li><li><p>Why does the compiler emit this exact sequence and not a slightly more straightforward sequence? I think it's partly avoiding overflow in cases where it might otherwise overflow  just a side effect of the way clang tracks and infers . I really don't know for sure, though. <em>and</em><a href="/202512/09-induction-variables" target="_blank" rel="noopener noreferrer">induction variables</a><a href="#fnref:why" target="_blank" rel="noopener noreferrer">↩</a></p></li></ol></div><hr /></div></div></div> <footer class="article-footer" data-astro-cid-wrgicudb> <div class="action-row" data-astro-cid-wrgicudb> <a href="http://xania.org/202512/24-cunning-clang?utm_source=feed&utm_medium=rss" target="_blank" rel="noopener noreferrer" class="read-original-btn" data-astro-cid-wrgicudb>
阅读原文 ↗
</a> </div> <div class="back-to-list" data-astro-cid-wrgicudb> <a href="/reading-list" class="back-link" data-astro-cid-wrgicudb>← 返回订阅列表</a> </div> </footer> </article> </div>  </main> <footer class="site-footer" aria-label="Site footer" data-astro-cid-sz7xmlte> <div class="footer-content" data-astro-cid-sz7xmlte> <p class="footer-text" data-astro-cid-sz7xmlte>
&copy; 2026 AstroBlog
</p> <p class="footer-text" data-astro-cid-sz7xmlte>
Built with  <a href="https://astro.build/" target="_blank" rel="noopener noreferrer" class="footer-link" data-astro-cid-sz7xmlte>
Astro
</a> </p> </div> </footer>  </body></html> 
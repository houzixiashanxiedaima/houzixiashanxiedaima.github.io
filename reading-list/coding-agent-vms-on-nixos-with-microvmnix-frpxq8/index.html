<!DOCTYPE html><html lang="zh-CN" data-astro-cid-sckkx6r4> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v5.17.1"><meta name="description" content="我逐渐认识到，Coding Agent 是处理任何程序代码的高效工具，无论用于学习程序架构、诊断漏洞还是开发新功能。"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self'; font-src 'self' data:;"><link rel="canonical" href="https://blog.yuyins.com/reading-list/coding-agent-vms-on-nixos-with-microvmnix-frpxq8/"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://blog.yuyins.com/reading-list/coding-agent-vms-on-nixos-with-microvmnix-frpxq8/"><meta property="og:title" content="在 NixOS 上使用 microvm.nix 开发 Coding Agent 虚拟机"><meta property="og:description" content="我逐渐认识到，Coding Agent 是处理任何程序代码的高效工具，无论用于学习程序架构、诊断漏洞还是开发新功能。"><meta property="og:image" content="https://blog.yuyins.com/favicon.svg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://blog.yuyins.com/reading-list/coding-agent-vms-on-nixos-with-microvmnix-frpxq8/"><meta property="twitter:title" content="在 NixOS 上使用 microvm.nix 开发 Coding Agent 虚拟机"><meta property="twitter:description" content="我逐渐认识到，Coding Agent 是处理任何程序代码的高效工具，无论用于学习程序架构、诊断漏洞还是开发新功能。"><meta property="twitter:image" content="https://blog.yuyins.com/favicon.svg"><title>在 NixOS 上使用 microvm.nix 开发 Coding Agent 虚拟机</title><!-- Theme and color scheme script (runs before page loads to prevent flash) --><script>
			// 初始化配色方案 - 默认使用 stone-amber
			const colorScheme = localStorage.getItem('colorScheme') || 'stone-amber';
			document.documentElement.setAttribute('data-color', colorScheme);

			// 强制使用浅色主题
			document.documentElement.setAttribute('data-theme', 'light');
		</script><link rel="stylesheet" href="/_astro/_slug_.CSpyZhxd.css">
<style>.blog-post-container[data-astro-cid-wrgicudb]{width:100%;margin:0 auto;padding:2rem 0}.blog-post[data-astro-cid-wrgicudb]{width:100%;min-width:0;max-width:42rem;margin:0 auto}.article-header[data-astro-cid-wrgicudb]{margin-bottom:2rem;padding-bottom:1rem;border-bottom:1px solid var(--border)}.article-header[data-astro-cid-wrgicudb] h1[data-astro-cid-wrgicudb]{font-size:2rem;line-height:1.3;margin-bottom:1rem;font-weight:700;color:var(--foreground);word-break:break-word}.article-meta[data-astro-cid-wrgicudb]{display:flex;align-items:center;gap:.5rem;font-size:.875rem;color:var(--muted-foreground)}.source-tag[data-astro-cid-wrgicudb]{background-color:var(--muted);color:var(--foreground);padding:.125rem .5rem;border-radius:9999px;font-weight:500;font-size:.75rem;text-decoration:none;transition:opacity .2s}.source-tag[data-astro-cid-wrgicudb]:hover{opacity:.8}.separator[data-astro-cid-wrgicudb]{color:var(--border)}.article-content[data-astro-cid-wrgicudb]{line-height:1.8;margin-bottom:3rem;font-size:1.0625rem;color:var(--foreground)}.article-content[data-astro-cid-wrgicudb] h2{margin-top:2rem;margin-bottom:1rem;font-size:1.5rem;font-weight:600}.article-content[data-astro-cid-wrgicudb] h3{margin-top:1.5rem;margin-bottom:.75rem;font-size:1.25rem;font-weight:600}.article-content[data-astro-cid-wrgicudb] p{margin-bottom:1.25rem}.article-content[data-astro-cid-wrgicudb] a{color:var(--accent);text-decoration:underline;text-underline-offset:2px}.article-content[data-astro-cid-wrgicudb] img{max-width:100%;height:auto;border-radius:.5rem;margin:1.5rem 0}.article-content[data-astro-cid-wrgicudb] blockquote{border-left:4px solid var(--border);padding-left:1rem;margin:1.5rem 0;color:var(--muted-foreground);font-style:italic}.article-content[data-astro-cid-wrgicudb] pre{background:var(--muted);padding:1rem;border-radius:.5rem;overflow-x:auto;font-family:monospace;margin:1.5rem 0}.article-content[data-astro-cid-wrgicudb] ul,.article-content[data-astro-cid-wrgicudb] ol{padding-left:1.5rem;margin-bottom:1.25rem}.article-content[data-astro-cid-wrgicudb] li{margin-bottom:.5rem}.article-footer[data-astro-cid-wrgicudb]{padding-top:2rem;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:1.5rem;align-items:center}.action-row[data-astro-cid-wrgicudb]{display:flex;justify-content:center}.read-original-btn[data-astro-cid-wrgicudb]{display:inline-flex;align-items:center;gap:.5rem;padding:.75rem 1.5rem;background-color:var(--foreground);color:var(--background);border-radius:.5rem;font-weight:500;text-decoration:none;transition:opacity .2s}.read-original-btn[data-astro-cid-wrgicudb]:hover{opacity:.9}.back-to-list[data-astro-cid-wrgicudb]{text-align:center}.back-link[data-astro-cid-wrgicudb]{color:var(--muted-foreground);text-decoration:none;font-size:.875rem;transition:color .2s}.back-link[data-astro-cid-wrgicudb]:hover{color:var(--foreground)}
</style></head> <body data-astro-cid-sckkx6r4> <a id="skip-to-content" href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:px-4 focus:py-2 focus:bg-accent focus:text-background" data-astro-cid-sckkx6r4>Skip to content</a> <header class="header" data-astro-cid-3ef6ksr2> <nav class="header-nav" aria-label="Main navigation" data-astro-cid-3ef6ksr2> <a href="/" class="header-logo" data-astro-cid-3ef6ksr2>
AstroBlog
</a> <div class="header-links" data-astro-cid-3ef6ksr2> <ul class="nav-list" data-astro-cid-3ef6ksr2> <li data-astro-cid-3ef6ksr2> <a href="/" class="nav-link" data-astro-prefetch="true" data-astro-cid-3ef6ksr2> 文章 </a> </li><li data-astro-cid-3ef6ksr2> <a href="/category" class="nav-link" data-astro-prefetch="true" data-astro-cid-3ef6ksr2> 分类 </a> </li><li data-astro-cid-3ef6ksr2> <a href="/reading-list" class="nav-link" data-astro-prefetch="true" data-astro-cid-3ef6ksr2> 订阅 </a> </li><li data-astro-cid-3ef6ksr2> <a href="/about" class="nav-link" data-astro-prefetch="true" data-astro-cid-3ef6ksr2> 关于 </a> </li> </ul> <div class="header-actions" data-astro-cid-3ef6ksr2> <div id="search" data-astro-cid-otpdt6jm> <button id="search-button" class="search-toggle" aria-label="打开搜索" title="搜索 (⌘K)" data-astro-cid-otpdt6jm> <svg class="search-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-astro-cid-otpdt6jm> <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2" stroke-linecap="round" data-astro-cid-otpdt6jm></circle> <path d="M20 20L16.5 16.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" data-astro-cid-otpdt6jm></path> </svg> </button> <dialog id="search-dialog" class="search-modal" data-astro-cid-otpdt6jm> <div class="modal-content" data-astro-cid-otpdt6jm> <div class="modal-header" data-astro-cid-otpdt6jm> <h2 class="modal-title" data-astro-cid-otpdt6jm>搜索文章</h2> <button id="close-search" class="close-button" aria-label="关闭搜索" data-astro-cid-otpdt6jm> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-astro-cid-otpdt6jm> <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-astro-cid-otpdt6jm></path> </svg> </button> </div> <div id="pagefind-ui" data-astro-cid-otpdt6jm></div> </div> </dialog> </div> <script type="module">let d=!1;const c="pagefind-loaded";async function l(t=0){if(sessionStorage.getItem(c)==="true")return g(),!0;const r=document.getElementById("pagefind-ui");if(!r)return!1;r.innerHTML='<div style="padding: 2rem; text-align: center; color: var(--muted-foreground);">加载中...</div>';try{return await new Promise((o,s)=>{const a=document.createElement("script");a.src="/pagefind/pagefind-ui.js",a.onload=o,a.onerror=s,document.head.appendChild(a)}),g(),sessionStorage.setItem(c,"true"),!0}catch(i){return console.error("Failed to load search:",i),t<2?(console.log(`Retrying search load... (${t+1}/2)`),await new Promise(o=>setTimeout(o,1e3)),l(t+1)):(r&&(r.innerHTML=`
          <div style="padding: 2rem; text-align: center;">
            <p style="color: var(--muted-foreground); margin-bottom: 1rem;">搜索功能加载失败</p>
            <button id="retry-search" style="padding: 0.5rem 1rem; background: var(--accent); color: var(--accent-foreground); border: none; border-radius: 0.375rem; cursor: pointer;">
              重试
            </button>
          </div>
        `,document.getElementById("retry-search")?.addEventListener("click",()=>{sessionStorage.removeItem(c),l(0)})),!1)}}function g(){typeof PagefindUI<"u"&&(new PagefindUI({element:"#pagefind-ui",showSubResults:!0,showImages:!1,excerptLength:15,translations:{placeholder:"搜索文章...",clear_search:"清除",load_more:"加载更多",search_label:"搜索此站点",filters_label:"筛选",zero_results:"未找到结果 [SEARCH_TERM]",many_results:"找到 [COUNT] 个结果 [SEARCH_TERM]",one_result:"找到 [COUNT] 个结果 [SEARCH_TERM]",alt_search:"未找到 [SEARCH_TERM] 的结果。显示 [DIFFERENT_TERM] 的结果",search_suggestion:"未找到 [SEARCH_TERM] 的结果。尝试以下搜索：",searching:"搜索中 [SEARCH_TERM]..."}}),setTimeout(()=>{const t=document.querySelector(".pagefind-ui__search-input");t instanceof HTMLElement&&t.focus()},100))}function u(){if(d)return;d=!0;const t=document.getElementById("search-button"),n=document.getElementById("search-dialog"),r=document.getElementById("close-search");if(!t||!n||!r)return;let i=sessionStorage.getItem(c)==="true";const o=async()=>{n.showModal(),document.body.style.overflow="hidden",i?setTimeout(()=>{const e=document.querySelector(".pagefind-ui__search-input");e instanceof HTMLElement&&e.focus()},100):await l()&&(i=!0)},s=()=>{n.close(),document.body.style.overflow=""},a=e=>{e.target===n&&s()},m=e=>{e.key==="Escape"&&n.open&&s()},f=e=>{(e.metaKey||e.ctrlKey)&&e.key==="k"&&(e.preventDefault(),n.open?s():o())};t.addEventListener("click",o),r.addEventListener("click",s),n.addEventListener("click",a),document.addEventListener("keydown",m),document.addEventListener("keydown",f),document.addEventListener("astro:before-swap",()=>{t.removeEventListener("click",o),r.removeEventListener("click",s),n.removeEventListener("click",a),document.removeEventListener("keydown",m),document.removeEventListener("keydown",f),d=!1},{once:!0})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",u):u();document.addEventListener("astro:page-load",u);</script> <link href="/pagefind/pagefind-ui.css" rel="stylesheet">  </div> </div> </nav> </header>  <main id="main-content" data-pagefind-body class="main-content main-content--wide" data-astro-cid-sckkx6r4>  <div class="blog-post-container" data-astro-cid-wrgicudb> <article class="blog-post" data-astro-cid-wrgicudb> <header class="article-header" data-astro-cid-wrgicudb> <h1 data-astro-cid-wrgicudb>在 NixOS 上使用 microvm.nix 开发 Coding Agent 虚拟机</h1> <div class="article-meta" data-astro-cid-wrgicudb> <a href="https://michael.stapelberg.ch" target="_blank" rel="noopener noreferrer" class="source-tag" data-astro-cid-wrgicudb>michael.stapelberg.ch</a> <span class="separator" data-astro-cid-wrgicudb>·</span> <time data-astro-cid-wrgicudb>2026年2月1日</time> </div> </header> <!-- 使用清洗后的安全 HTML 内容 --> <div class="article-content app-prose" data-astro-cid-wrgicudb><p>I have come to appreciate <a href="https://en.wikipedia.org/wiki/AI-assisted_software_development" target="_blank" rel="noopener noreferrer">coding
agents</a> to be
valuable tools for working with computer program code in any capacity, such as
learning about any program’s architecture, diagnosing bugs or developing proofs
of concept. Depending on the use-case, reviewing each command the agent wants to
run can get tedious and time-consuming very quickly. To safely run a coding
agent without review, I wanted a Virtual Machine (VM) solution where the agent
has no access to my personal files and where it’s no big deal if the agent gets
compromised by malware: I can just throw away the VM and start over.</p>
<p>Instead of setting up a stateful VM and re-installing it when needed (ugh!), I
prefer the model of ephemeral VMs where nothing persists on disk, except for
what is explicitly shared with the host.</p>
<p>The <a href="https://github.com/microvm-nix/microvm.nix" target="_blank" rel="noopener noreferrer"><code>microvm.nix</code> project</a> makes it
easy to create such VMs on NixOS, and this article shows you how I like to set
up my VMs.</p>
<h2>See also</h2>
<p>If you haven’t heard of NixOS before, check out <a href="https://en.wikipedia.org/wiki/NixOS" target="_blank" rel="noopener noreferrer">the NixOS Wikipedia
page</a> and
<a href="https://nixos.org/" target="_blank" rel="noopener noreferrer">nixos.org</a>. I <a href="/talks/#2025" target="_blank" rel="noopener noreferrer">spoke about why I switched to Nix in
2025</a> and have published a <a href="/posts/tags/nix/" target="_blank" rel="noopener noreferrer">few blog posts about
Nix</a>.</p>
<p>For understanding the threat model of AI agents, read <a href="https://simonwillison.net/2025/Jun/16/the-lethal-trifecta/" target="_blank" rel="noopener noreferrer">Simon Willison’s “The
lethal trifecta for AI agents: private data, untrusted content, and external
communication” (June
2025)</a>. This
article’s approach to working with the threat model is to remove the “private
data” part from the equation.</p>
<p>If you want to learn about the whole field of sandboxing, check out <a href="https://www.luiscardoso.dev/blog/sandboxes-for-ai" target="_blank" rel="noopener noreferrer">Luis
Cardoso’s “A field guide to sandboxes for AI” (Jan
2026)</a>. I will not be
comparing different solutions in this article, I will just show you one possible
path.</p>
<p>And lastly, maybe you’re not in the mood to build/run sandboxing infrastructure
yourself. Good news: Sandboxing is a hot topic and there are many commercial
offerings popping up that address this need. For example, David Crawshaw and
Josh Bleecher Snyder (I know both from the Go community) recently launched
<a href="https://blog.exe.dev/meet-exe.dev" target="_blank" rel="noopener noreferrer">exe.dev</a>, an agent-friendly VM hosting
service. Another example is <a href="https://fly.io/blog/code-and-let-live/" target="_blank" rel="noopener noreferrer">Fly.io, who launched
Sprites</a>.</p>
<h2>Setting up microvm.nix</h2>
<p>Let’s jump right in! The next sections walk you through how I set up my config.</p>
<h3>Step 1: network prep</h3>
<p>First, I created a new <code>microbr</code> bridge which uses <code>192.168.33.1/24</code> as IP address range and NATs out of the <code>eno1</code> network interface. All <code>microvm*</code> interfaces will be added to that bridge:</p>
<div><pre><code><span><span>systemd<span>.</span>network<span>.</span>netdevs<span>.</span><span>"20-microbr"</span><span>.</span>netdevConfig <span>=</span> {
</span></span><span><span>  Kind <span>=</span> <span>"bridge"</span>;
</span></span><span><span>  Name <span>=</span> <span>"microbr"</span>;
</span></span><span><span>};
</span></span><span><span>
</span></span><span><span>systemd<span>.</span>network<span>.</span>networks<span>.</span><span>"20-microbr"</span> <span>=</span> {
</span></span><span><span>  matchConfig<span>.</span>Name <span>=</span> <span>"microbr"</span>;
</span></span><span><span>  addresses <span>=</span> [ { Address <span>=</span> <span>"192.168.83.1/24"</span>; } ];
</span></span><span><span>  networkConfig <span>=</span> {
</span></span><span><span>    ConfigureWithoutCarrier <span>=</span> <span>true</span>;
</span></span><span><span>  };
</span></span><span><span>};
</span></span><span><span>
</span></span><span><span>systemd<span>.</span>network<span>.</span>networks<span>.</span><span>"21-microvm-tap"</span> <span>=</span> {
</span></span><span><span>  matchConfig<span>.</span>Name <span>=</span> <span>"microvm*"</span>;
</span></span><span><span>  networkConfig<span>.</span>Bridge <span>=</span> <span>"microbr"</span>;
</span></span><span><span>};
</span></span><span><span>
</span></span><span><span>networking<span>.</span>nat <span>=</span> {
</span></span><span><span>  enable <span>=</span> <span>true</span>;
</span></span><span><span>  internalInterfaces <span>=</span> [ <span>"microbr"</span> ];
</span></span><span><span>  externalInterface <span>=</span> <span>"eno1"</span>;
</span></span><span><span>};
</span></span></code></pre></div><h3>Step 2: <code>flake.nix</code></h3>
<p>Then, I added the <code>microvm</code> module as a new input to my <code>flake.nix</code> (check out
the <a href="https://microvm-nix.github.io/microvm.nix/" target="_blank" rel="noopener noreferrer">microvm.nix documentation</a> for
details) and enabled the <code>microvm.nixosModules.host</code> module on the NixOS
configuration for my PC (midna). I also created a new <code>microvm.nix</code> file, in
which I declare all my VMs. Here’s what my <code>flake.nix</code> looks like:</p>
<div><pre><code><span><span>{
</span></span><span><span>  inputs <span>=</span> {
</span></span><span><span>    nixpkgs <span>=</span> {
</span></span><span><span>      url <span>=</span> <span>"github:nixos/nixpkgs/nixos-25.11"</span>;
</span></span><span><span>    };
</span></span><span><span>    <span># For more recent claude-code</span>
</span></span><span><span>    nixpkgs-unstable <span>=</span> {
</span></span><span><span>      url <span>=</span> <span>"github:nixos/nixpkgs/nixos-unstable"</span>;
</span></span><span><span>    };
</span></span><span><span>    stapelbergnix <span>=</span> {
</span></span><span><span>      url <span>=</span> <span>"github:stapelberg/nix"</span>;
</span></span><span><span>      inputs<span>.</span>nixpkgs<span>.</span>follows <span>=</span> <span>"nixpkgs"</span>;
</span></span><span><span>    };
</span></span><span><span>    zkjnastools <span>=</span> {
</span></span><span><span>      url <span>=</span> <span>"github:stapelberg/zkj-nas-tools"</span>;
</span></span><span><span>      inputs<span>.</span>nixpkgs<span>.</span>follows <span>=</span> <span>"nixpkgs"</span>;
</span></span><span><span>    };
</span></span><span><span>    microvm <span>=</span> {
</span></span><span><span>      url <span>=</span> <span>"github:microvm-nix/microvm.nix"</span>;
</span></span><span><span>      inputs<span>.</span>nixpkgs<span>.</span>follows <span>=</span> <span>"nixpkgs"</span>;
</span></span><span><span>    };
</span></span><span><span>    home-manager <span>=</span> {
</span></span><span><span>      url <span>=</span> <span>"github:nix-community/home-manager/release-25.11"</span>;
</span></span><span><span>      inputs<span>.</span>nixpkgs<span>.</span>follows <span>=</span> <span>"nixpkgs"</span>;
</span></span><span><span>    };
</span></span><span><span>    configfiles <span>=</span> {
</span></span><span><span>      url <span>=</span> <span>"github:stapelberg/configfiles"</span>;
</span></span><span><span>      flake <span>=</span> <span>false</span>; <span># repo is not a flake</span>
</span></span><span><span>    };
</span></span><span><span>  };
</span></span><span><span>
</span></span><span><span>  outputs <span>=</span>
</span></span><span><span>    {
</span></span><span><span>      self<span>,</span>
</span></span><span><span>      stapelbergnix<span>,</span>
</span></span><span><span>      zkjnastools<span>,</span>
</span></span><span><span>      nixpkgs<span>,</span>
</span></span><span><span>      nixpkgs-unstable<span>,</span>
</span></span><span><span>      microvm<span>,</span>
</span></span><span><span>      home-manager<span>,</span>
</span></span><span><span>      configfiles<span>,</span>
</span></span><span><span>    }<span>@</span>inputs:
</span></span><span><span>    <span>let</span>
</span></span><span><span>      system <span>=</span> <span>"x86_64-linux"</span>;
</span></span><span><span>      pkgs <span>=</span> <span>import</span> nixpkgs {
</span></span><span><span>        <span>inherit</span> system;
</span></span><span><span>        config<span>.</span>allowUnfree <span>=</span> <span>false</span>;
</span></span><span><span>      };
</span></span><span><span>      pkgs-unstable <span>=</span> <span>import</span> nixpkgs-unstable {
</span></span><span><span>        <span>inherit</span> system;
</span></span><span><span>        config<span>.</span>allowUnfree <span>=</span> <span>true</span>;
</span></span><span><span>      };
</span></span><span><span>    <span>in</span>
</span></span><span><span>    {
</span></span><span><span>      nixosConfigurations <span>=</span> {
</span></span><span><span>        midna <span>=</span> nixpkgs<span>.</span>lib<span>.</span>nixosSystem {
</span></span><span><span>          system <span>=</span> <span>"x86_64-linux"</span>;
</span></span><span><span>          specialArgs <span>=</span> { <span>inherit</span> inputs; };
</span></span><span><span>          modules <span>=</span> [
</span></span><span><span>            (<span>import</span> <span>./configuration.nix</span>)
</span></span><span><span>            stapelbergnix<span>.</span>lib<span>.</span>userSettings
</span></span><span><span>            <span># Use systemd for network configuration</span>
</span></span><span><span>            stapelbergnix<span>.</span>lib<span>.</span>systemdNetwork
</span></span><span><span>            <span># Use systemd-boot as bootloader</span>
</span></span><span><span>            stapelbergnix<span>.</span>lib<span>.</span>systemdBoot
</span></span><span><span>            <span># Run prometheus node exporter in tailnet</span>
</span></span><span><span>            stapelbergnix<span>.</span>lib<span>.</span>prometheusNode
</span></span><span><span>            zkjnastools<span>.</span>nixosModules<span>.</span>zkjbackup
</span></span><span><span>            microvm<span>.</span>nixosModules<span>.</span>host
</span></span><span><span>            <span>./microvm.nix</span>
</span></span><span><span>          ];
</span></span><span><span>        };
</span></span><span><span>      };
</span></span><span><span>    };
</span></span><span><span>}</span></span></code></pre></div>
<h3>Step 3: <code>microvm.nix</code></h3>
<p>The following <code>microvm.nix</code> declares two microvms, one for Emacs (about which I wanted to learn more) and one for Go Protobuf, a code base I am familiar with and can use to understand Claude’s capabilities:</p>
<div><pre><code><span><span>{
</span></span><span><span>  config<span>,</span>
</span></span><span><span>  lib<span>,</span>
</span></span><span><span>  pkgs<span>,</span>
</span></span><span><span>  inputs<span>,</span>
</span></span><span><span>  <span>...</span>
</span></span><span><span>}:
</span></span><span><span>
</span></span><span><span><span>let</span>
</span></span><span><span>  <span>inherit</span> (inputs)
</span></span><span><span>    nixpkgs-unstable
</span></span><span><span>    stapelbergnix
</span></span><span><span>    microvm
</span></span><span><span>    configfiles
</span></span><span><span>    home-manager
</span></span><span><span>    ;
</span></span><span><span>
</span></span><span><span>  microvmBase <span>=</span> <span>import</span> <span>./microvm-base.nix</span>;
</span></span><span><span><span>in</span>
</span></span><span><span>{
</span></span><span><span>  microvm<span>.</span>vms<span>.</span>emacsvm <span>=</span> {
</span></span><span><span>    autostart <span>=</span> <span>false</span>;
</span></span><span><span>    config <span>=</span> {
</span></span><span><span>      imports <span>=</span> [
</span></span><span><span>        stapelbergnix<span>.</span>lib<span>.</span>userSettings
</span></span><span><span>        microvm<span>.</span>nixosModules<span>.</span>microvm
</span></span><span><span>        (microvmBase {
</span></span><span><span>          hostName <span>=</span> <span>"emacsvm"</span>;
</span></span><span><span>          ipAddress <span>=</span> <span>"192.168.83.6"</span>;
</span></span><span><span>          tapId <span>=</span> <span>"microvm4"</span>;
</span></span><span><span>          mac <span>=</span> <span>"02:00:00:00:00:05"</span>;
</span></span><span><span>          workspace <span>=</span> <span>"/home/michael/microvm/emacs"</span>;
</span></span><span><span>          <span>inherit</span>
</span></span><span><span>            nixpkgs-unstable
</span></span><span><span>            configfiles
</span></span><span><span>            home-manager
</span></span><span><span>            stapelbergnix
</span></span><span><span>            ;
</span></span><span><span>        })
</span></span><span><span>        <span>./microvms/emacs.nix</span>
</span></span><span><span>      ];
</span></span><span><span>    };
</span></span><span><span>  };
</span></span><span><span>
</span></span><span><span>  microvm<span>.</span>vms<span>.</span>goprotobufvm <span>=</span> {
</span></span><span><span>    autostart <span>=</span> <span>false</span>;
</span></span><span><span>    config <span>=</span> {
</span></span><span><span>      imports <span>=</span> [
</span></span><span><span>        stapelbergnix<span>.</span>lib<span>.</span>userSettings
</span></span><span><span>        microvm<span>.</span>nixosModules<span>.</span>microvm
</span></span><span><span>        (microvmBase {
</span></span><span><span>          hostName <span>=</span> <span>"goprotobufvm"</span>;
</span></span><span><span>          ipAddress <span>=</span> <span>"192.168.83.7"</span>;
</span></span><span><span>          tapId <span>=</span> <span>"microvm5"</span>;
</span></span><span><span>          mac <span>=</span> <span>"02:00:00:00:00:06"</span>;
</span></span><span><span>          workspace <span>=</span> <span>"/home/michael/microvm/goprotobuf"</span>;
</span></span><span><span>          <span>inherit</span>
</span></span><span><span>            nixpkgs-unstable
</span></span><span><span>            configfiles
</span></span><span><span>            home-manager
</span></span><span><span>            stapelbergnix
</span></span><span><span>            ;
</span></span><span><span>          extraZshInit <span>=</span> <span>''
</span></span></span><span><span><span>            export GOPATH=$HOME/go
</span></span></span><span><span><span>            export PATH=$GOPATH/bin:$PATH
</span></span></span><span><span><span>          ''</span>;
</span></span><span><span>        })
</span></span><span><span>        <span>./microvms/goprotobuf.nix</span>
</span></span><span><span>      ];
</span></span><span><span>    };
</span></span><span><span>  };
</span></span><span><span>}
</span></span></code></pre></div><h3>Step 4: <code>microvm-base.nix</code></h3>
<p>The <code>microvm-base.nix</code> module takes these parameters and declares:</p>
<ul>
<li>Network settings: I like using <a href="https://manpages.debian.org/systemd-networkd.8" target="_blank" rel="noopener noreferrer"><code>systemd-networkd(8)</code></a>
 and <a href="https://manpages.debian.org/systemd-resolved.8" target="_blank" rel="noopener noreferrer"><code>systemd-resolved(8)</code></a>
.</li>
<li>Shared directories for:
<ul>
<li>the workspace directory, e.g. <code>~/microvm/emacs</code></li>
<li>the host’s Nix store, so the VM can access software from cache (often)</li>
<li>this VM’s SSH host keys</li>
<li><code>~/claude-microvm</code>, which is a separate state directory, used only on the microvms.</li>
</ul>
</li>
<li>an 8 GB disk overlay (var.img), stored in <code>/var/lib/microvms/&lt;name&gt;</code></li>
<li><code>cloud-hypervisor</code> (QEMU also works well!) as the hypervisor, with 8 vCPUs and 4 GB RAM.</li>
<li>A workaround for systemd trying to unmount <code>/nix/store</code> (which causes a deadlock).</li>
</ul>

Expand full <code>microvm-base.nix</code> code
<div><pre><code><span><span>{
</span></span><span><span>  hostName<span>,</span>
</span></span><span><span>  ipAddress<span>,</span>
</span></span><span><span>  tapId<span>,</span>
</span></span><span><span>  mac<span>,</span>
</span></span><span><span>  workspace<span>,</span>
</span></span><span><span>  nixpkgs-unstable<span>,</span>
</span></span><span><span>  configfiles<span>,</span>
</span></span><span><span>  home-manager<span>,</span>
</span></span><span><span>  stapelbergnix<span>,</span>
</span></span><span><span>  extraZshInit <span>?</span> <span>""</span><span>,</span>
</span></span><span><span>}:
</span></span><span><span>
</span></span><span><span>{
</span></span><span><span>  config<span>,</span>
</span></span><span><span>  lib<span>,</span>
</span></span><span><span>  pkgs<span>,</span>
</span></span><span><span>  <span>...</span>
</span></span><span><span>}:
</span></span><span><span>
</span></span><span><span><span>let</span>
</span></span><span><span>  system <span>=</span> pkgs<span>.</span>stdenv<span>.</span>hostPlatform<span>.</span>system;
</span></span><span><span>  pkgsUnstable <span>=</span> <span>import</span> nixpkgs-unstable {
</span></span><span><span>    <span>inherit</span> system;
</span></span><span><span>    config<span>.</span>allowUnfree <span>=</span> <span>true</span>;
</span></span><span><span>  };
</span></span><span><span><span>in</span>
</span></span><span><span>{
</span></span><span><span>  imports <span>=</span> [ home-manager<span>.</span>nixosModules<span>.</span>home-manager ];
</span></span><span><span>
</span></span><span><span>  <span># home-manager configuration</span>
</span></span><span><span>  home-manager<span>.</span>useGlobalPkgs <span>=</span> <span>true</span>;
</span></span><span><span>  home-manager<span>.</span>useUserPackages <span>=</span> <span>true</span>;
</span></span><span><span>  home-manager<span>.</span>extraSpecialArgs <span>=</span> { <span>inherit</span> configfiles stapelbergnix; };
</span></span><span><span>  home-manager<span>.</span>users<span>.</span>michael <span>=</span> {
</span></span><span><span>    imports <span>=</span> [ <span>./microvm-home.nix</span> ];
</span></span><span><span>    microvm<span>.</span>extraZshInit <span>=</span> extraZshInit;
</span></span><span><span>  };
</span></span><span><span>
</span></span><span><span>  <span># Claude Code CLI (from nixpkgs-unstable, unfree)</span>
</span></span><span><span>  environment<span>.</span>systemPackages <span>=</span> [
</span></span><span><span>    pkgsUnstable<span>.</span>claude-code
</span></span><span><span>  ];
</span></span><span><span>  networking<span>.</span>hostName <span>=</span> hostName;
</span></span><span><span>
</span></span><span><span>  system<span>.</span>stateVersion <span>=</span> <span>"25.11"</span>;
</span></span><span><span>
</span></span><span><span>  services<span>.</span>openssh<span>.</span>enable <span>=</span> <span>true</span>;
</span></span><span><span>
</span></span><span><span>  <span># To match midna (host)</span>
</span></span><span><span>  users<span>.</span>groups<span>.</span>michael <span>=</span> {
</span></span><span><span>    gid <span>=</span> <span>1000</span>;
</span></span><span><span>  };
</span></span><span><span>  users<span>.</span>users<span>.</span>michael <span>=</span> {
</span></span><span><span>    group <span>=</span> <span>"michael"</span>;
</span></span><span><span>  };
</span></span><span><span>
</span></span><span><span>  services<span>.</span>resolved<span>.</span>enable <span>=</span> <span>true</span>;
</span></span><span><span>  networking<span>.</span>useDHCP <span>=</span> <span>false</span>;
</span></span><span><span>  networking<span>.</span>useNetworkd <span>=</span> <span>true</span>;
</span></span><span><span>  networking<span>.</span>tempAddresses <span>=</span> <span>"disabled"</span>;
</span></span><span><span>  systemd<span>.</span>network<span>.</span>enable <span>=</span> <span>true</span>;
</span></span><span><span>  systemd<span>.</span>network<span>.</span>networks<span>.</span><span>"10-e"</span> <span>=</span> {
</span></span><span><span>    matchConfig<span>.</span>Name <span>=</span> <span>"e*"</span>;
</span></span><span><span>    addresses <span>=</span> [ { Address <span>=</span> <span>"</span><span>${</span>ipAddress<span>}</span><span>/24"</span>; } ];
</span></span><span><span>    routes <span>=</span> [ { Gateway <span>=</span> <span>"192.168.83.1"</span>; } ];
</span></span><span><span>  };
</span></span><span><span>  networking<span>.</span>nameservers <span>=</span> [
</span></span><span><span>    <span>"8.8.8.8"</span>
</span></span><span><span>    <span>"1.1.1.1"</span>
</span></span><span><span>  ];
</span></span><span><span>
</span></span><span><span>  <span># Disable firewall for faster boot and less hassle;</span>
</span></span><span><span>  <span># we are behind a layer of NAT anyway.</span>
</span></span><span><span>  networking<span>.</span>firewall<span>.</span>enable <span>=</span> <span>false</span>;
</span></span><span><span>
</span></span><span><span>  systemd<span>.</span>settings<span>.</span>Manager <span>=</span> {
</span></span><span><span>    <span># fast shutdowns/reboots! https://mas.to/@zekjur/113109742103219075</span>
</span></span><span><span>    DefaultTimeoutStopSec <span>=</span> <span>"5s"</span>;
</span></span><span><span>  };
</span></span><span><span>
</span></span><span><span>  <span># Fix for microvm shutdown hang (issue #170):</span>
</span></span><span><span>  <span># Without this, systemd tries to unmount /nix/store during shutdown,</span>
</span></span><span><span>  <span># but umount lives in /nix/store, causing a deadlock.</span>
</span></span><span><span>  systemd<span>.</span>mounts <span>=</span> [
</span></span><span><span>    {
</span></span><span><span>      what <span>=</span> <span>"store"</span>;
</span></span><span><span>      where <span>=</span> <span>"/nix/store"</span>;
</span></span><span><span>      overrideStrategy <span>=</span> <span>"asDropin"</span>;
</span></span><span><span>      unitConfig<span>.</span>DefaultDependencies <span>=</span> <span>false</span>;
</span></span><span><span>    }
</span></span><span><span>  ];
</span></span><span><span>
</span></span><span><span>  <span># Use SSH host keys mounted from outside the VM (remain identical).</span>
</span></span><span><span>  services<span>.</span>openssh<span>.</span>hostKeys <span>=</span> [
</span></span><span><span>    {
</span></span><span><span>      path <span>=</span> <span>"/etc/ssh/host-keys/ssh_host_ed25519_key"</span>;
</span></span><span><span>      type <span>=</span> <span>"ed25519"</span>;
</span></span><span><span>    }
</span></span><span><span>  ];
</span></span><span><span>
</span></span><span><span>  microvm <span>=</span> {
</span></span><span><span>    <span># Enable writable nix store overlay so nix-daemon works.</span>
</span></span><span><span>    <span># This is required for home-manager activation.</span>
</span></span><span><span>    <span># Uses tmpfs by default (ephemeral), which is fine since we</span>
</span></span><span><span>    <span># don't build anything in the VM.</span>
</span></span><span><span>    writableStoreOverlay <span>=</span> <span>"/nix/.rw-store"</span>;
</span></span><span><span>
</span></span><span><span>    volumes <span>=</span> [
</span></span><span><span>      {
</span></span><span><span>        mountPoint <span>=</span> <span>"/var"</span>;
</span></span><span><span>        image <span>=</span> <span>"var.img"</span>;
</span></span><span><span>        size <span>=</span> <span>8192</span>; <span># MB</span>
</span></span><span><span>      }
</span></span><span><span>    ];
</span></span><span><span>
</span></span><span><span>    shares <span>=</span> [
</span></span><span><span>      {
</span></span><span><span>        <span># use proto = "virtiofs" for MicroVMs that are started by systemd</span>
</span></span><span><span>        proto <span>=</span> <span>"virtiofs"</span>;
</span></span><span><span>        tag <span>=</span> <span>"ro-store"</span>;
</span></span><span><span>        <span># a host's /nix/store will be picked up so that no</span>
</span></span><span><span>        <span># squashfs/erofs will be built for it.</span>
</span></span><span><span>        source <span>=</span> <span>"/nix/store"</span>;
</span></span><span><span>        mountPoint <span>=</span> <span>"/nix/.ro-store"</span>;
</span></span><span><span>      }
</span></span><span><span>      {
</span></span><span><span>        proto <span>=</span> <span>"virtiofs"</span>;
</span></span><span><span>        tag <span>=</span> <span>"ssh-keys"</span>;
</span></span><span><span>        source <span>=</span> <span>"</span><span>${</span>workspace<span>}</span><span>/ssh-host-keys"</span>;
</span></span><span><span>        mountPoint <span>=</span> <span>"/etc/ssh/host-keys"</span>;
</span></span><span><span>      }
</span></span><span><span>      {
</span></span><span><span>        proto <span>=</span> <span>"virtiofs"</span>;
</span></span><span><span>        tag <span>=</span> <span>"claude-credentials"</span>;
</span></span><span><span>        source <span>=</span> <span>"/home/michael/claude-microvm"</span>;
</span></span><span><span>        mountPoint <span>=</span> <span>"/home/michael/claude-microvm"</span>;
</span></span><span><span>      }
</span></span><span><span>      {
</span></span><span><span>        proto <span>=</span> <span>"virtiofs"</span>;
</span></span><span><span>        tag <span>=</span> <span>"workspace"</span>;
</span></span><span><span>        source <span>=</span> workspace;
</span></span><span><span>        mountPoint <span>=</span> workspace;
</span></span><span><span>      }
</span></span><span><span>    ];
</span></span><span><span>
</span></span><span><span>    interfaces <span>=</span> [
</span></span><span><span>      {
</span></span><span><span>        type <span>=</span> <span>"tap"</span>;
</span></span><span><span>        id <span>=</span> tapId;
</span></span><span><span>        mac <span>=</span> mac;
</span></span><span><span>      }
</span></span><span><span>    ];
</span></span><span><span>
</span></span><span><span>    hypervisor <span>=</span> <span>"cloud-hypervisor"</span>;
</span></span><span><span>    vcpu <span>=</span> <span>8</span>;
</span></span><span><span>    mem <span>=</span> <span>4096</span>;
</span></span><span><span>    socket <span>=</span> <span>"control.socket"</span>;
</span></span><span><span>  };
</span></span><span><span>}
</span></span></code></pre></div>
<h3>Step 5: <code>microvm-home.nix</code></h3>
<p><code>microvm-base.nix</code> in turn pulls in <code>microvm-home.nix</code>, which sets up home-manager to:</p>
<ul>
<li>Set up Zsh with my configuration</li>
<li>Set up Emacs with my configuration</li>
<li>Set up Claude Code in shared directory <code>~/claude-microvm</code>.</li>
</ul>

Expand full <code>microvm-home.nix</code> code
<div><pre><code><span><span>{
</span></span><span><span>  config<span>,</span>
</span></span><span><span>  pkgs<span>,</span>
</span></span><span><span>  lib<span>,</span>
</span></span><span><span>  configfiles<span>,</span>
</span></span><span><span>  stapelbergnix<span>,</span>
</span></span><span><span>  <span>...</span>
</span></span><span><span>}:
</span></span><span><span>
</span></span><span><span>{
</span></span><span><span>  options<span>.</span>microvm <span>=</span> {
</span></span><span><span>    extraZshInit <span>=</span> lib<span>.</span>mkOption {
</span></span><span><span>      type <span>=</span> lib<span>.</span>types<span>.</span>lines;
</span></span><span><span>      default <span>=</span> <span>""</span>;
</span></span><span><span>      description <span>=</span> <span>"Extra lines to add to zsh initContent"</span>;
</span></span><span><span>    };
</span></span><span><span>  };
</span></span><span><span>
</span></span><span><span>  config <span>=</span> {
</span></span><span><span>    home<span>.</span>username <span>=</span> <span>"michael"</span>;
</span></span><span><span>    home<span>.</span>homeDirectory <span>=</span> <span>"/home/michael"</span>;
</span></span><span><span>
</span></span><span><span>    programs<span>.</span>zsh <span>=</span> {
</span></span><span><span>      enable <span>=</span> <span>true</span>;
</span></span><span><span>      history <span>=</span> {
</span></span><span><span>        size <span>=</span> <span>4000</span>;
</span></span><span><span>        save <span>=</span> <span>10000000</span>;
</span></span><span><span>        ignoreDups <span>=</span> <span>true</span>;
</span></span><span><span>        share <span>=</span> <span>false</span>;
</span></span><span><span>        append <span>=</span> <span>true</span>;
</span></span><span><span>      };
</span></span><span><span>
</span></span><span><span>      initContent <span>=</span> <span>''
</span></span></span><span><span><span>        </span><span>${</span><span>builtins</span><span>.</span>readFile <span>"</span><span>${</span>configfiles<span>}</span><span>/zshrc"</span><span>}</span><span>
</span></span></span><span><span><span>        export CLAUDE_CONFIG_DIR=/home/michael/claude-microvm
</span></span></span><span><span><span>        </span><span>${</span>config<span>.</span>microvm<span>.</span>extraZshInit<span>}</span><span>
</span></span></span><span><span><span>      ''</span>;
</span></span><span><span>    };
</span></span><span><span>
</span></span><span><span>    programs<span>.</span>emacs <span>=</span> {
</span></span><span><span>      enable <span>=</span> <span>true</span>;
</span></span><span><span>      package <span>=</span> stapelbergnix<span>.</span>lib<span>.</span>emacsWithPackages { <span>inherit</span> pkgs; };
</span></span><span><span>    };
</span></span><span><span>
</span></span><span><span>    home<span>.</span>file<span>.</span><span>".config/emacs"</span> <span>=</span> {
</span></span><span><span>      source <span>=</span> <span>"</span><span>${</span>configfiles<span>}</span><span>/config/emacs"</span>;
</span></span><span><span>    };
</span></span><span><span>
</span></span><span><span>    home<span>.</span>stateVersion <span>=</span> <span>"25.11"</span>;
</span></span><span><span>
</span></span><span><span>    programs<span>.</span>home-manager<span>.</span>enable <span>=</span> <span>true</span>;
</span></span><span><span>  };
</span></span><span><span>}
</span></span></code></pre></div>
<h3>Step 6: <code>goprotobuf.nix</code></h3>
<p>The <code>goprotobuf.nix</code> makes available a bunch of required and convenient packages:</p>
<div><pre><code><span><span><span># Project-specific configuration for goprotobufvm</span>
</span></span><span><span>{ pkgs<span>,</span> <span>...</span> }:
</span></span><span><span>{
</span></span><span><span>  <span># Development environment for Go Protobuf</span>
</span></span><span><span>  environment<span>.</span>systemPackages <span>=</span> <span>with</span> pkgs; [
</span></span><span><span>    <span># Go toolchain</span>
</span></span><span><span>    go
</span></span><span><span>    gopls
</span></span><span><span>    delve
</span></span><span><span>    protobuf
</span></span><span><span>    gnumake
</span></span><span><span>    gcc
</span></span><span><span>    git
</span></span><span><span>    ripgrep
</span></span><span><span>  ];
</span></span><span><span>}
</span></span></code></pre></div><h3>Running the VM</h3>
<p>Let’s create the workspace directory and create an SSH host key:</p>
<pre><code>mkdir -p ~/microvm/emacs/ssh-host-keys
ssh-keygen -t ed25519 -N "" \
  -f ~/microvm/emacs/ssh-host-keys/ssh_host_ed25519_key
</code></pre><p>Now we can start the VM:</p>
<pre><code>sudo systemctl start microvm@emacsvm
</code></pre><p>It boots and responds to pings within a few seconds.</p>
<p>Then, SSH into the VM (perhaps in a <a href="https://manpages.debian.org/tmux.1" target="_blank" rel="noopener noreferrer"><code>tmux(1)</code></a>
 session) and run Claude
(or your Coding Agent of choice) without permission prompts in the shared
workspace directory:</p>
<pre><code>% ssh 192.168.83.2
emacsvm% cd microvm/emacs
emacsvm% claude --dangerously-skip-permissions
</code></pre><p>This is what running Claude in such a setup looks like:</p>















<a href="https://michael.stapelberg.ch/posts/2026-02-01-coding-agent-microvm-nix/2026-01-28-neofetch-featured.png" target="_blank" rel="noopener noreferrer"><img src="https://michael.stapelberg.ch/posts/2026-02-01-coding-agent-microvm-nix/2026-01-28-neofetch-featured_hu_d06e7aa7176833b3.png" alt="Claude Code in “bypass permissions” mode" title="Claude Code in “bypass permissions” mode" width="600" height="479" /></a>



<h2>Creating VMs with Claude</h2>
<p>After going through the process of setting up a MicroVM once, it becomes tedious.</p>
<p>I was curious if <a href="https://code.claude.com/docs/en/skills" target="_blank" rel="noopener noreferrer">Claude Skills</a> could
help with a task like this. Skills are markdown files that instruct Claude to do
certain steps in certain situations.</p>
<p>I created <code>.claude/skills/create-microvm/SKILL.md</code> as follows:</p>
<div><pre><code><span><span>---
</span></span><span><span>name: create-microvm
</span></span><span><span>description: Creates a new microvm Virtual Machine on midna for running Claude in, with source code repositories and build dependencies available inside the microvm. Use when the user asks to create a new microvm.
</span></span><span><span>---
</span></span><span><span>
</span></span><span><span>Inspect the existing structure at ~/machines/midna (NixOS configuration using Flakes), which includes several MicroVMs in the ~/machines/midna/microvms/ directory.
</span></span><span><span>
</span></span><span><span>Then, create a similar structure for the microvm the user asked to create. Be sure to consider:
</span></span><span><span>
</span></span><span><span><span>1.</span> Create a new subdirectory for this microvm, named NAME (the microvm name).
</span></span><span><span><span>2.</span> Create an entry in microvm.nix similar to an existing microvm's, but:
</span></span><span><span><span>3.</span> Change hostname to NAME
</span></span><span><span><span>4.</span> Change IP address (e.g., 192.168.83.3): find used ones and chose next free
</span></span><span><span><span>5.</span> Change workspace share to /home/michael/microvm/NAME
</span></span><span><span><span>6.</span> Include build dependencies for the new microvm based on user request
</span></span><span><span><span>7.</span> Create ssh-host-keys directory
</span></span><span><span><span>8.</span> Generate SSH host keys
</span></span><span><span><span>9.</span> Clone/download source code repositories into this microvm based on user request
</span></span><span><span>
</span></span><span><span>Once the microvm is defined, update ~/machines/midna to pull it in. To verify, build the config (but do not deploy).
</span></span><span><span>
</span></span><span><span>You need to git-commit changes to the microvm before ~/machines/midna can see them.
</span></span></code></pre></div><p>When using this skill with Claude Code (tested version: v2.0.76 and v2.1.15), with the <a href="https://www.anthropic.com/news/claude-opus-4-5" target="_blank" rel="noopener noreferrer">Opus 4.5 model</a>, I can send a prompt like this:</p>
<blockquote>
<p>please set up a microvm for Debian Code Search (dcs). see ~/dcs for the source code (but clone from <a href="https://github.com/Debian/dcs" target="_blank" rel="noopener noreferrer">https://github.com/Debian/dcs</a>)</p>
</blockquote>
<p>Now Claude churns for a few minutes, possibly asking a clarification question
before that. Afterwards, Claude reports back with:</p>
<blockquote>
<p>The dcsvm microvm has been set up successfully. Here’s what was created:</p>
<p>Configuration:</p>
<ul>
<li>/home/michael/machines/midna/microvms/dcs.nix - Project-specific packages (Go toolchain, protobuf tools, uglify-js, yuicompressor,
zopfli)</li>
<li>Updated /home/michael/machines/midna/microvm.nix to include dcsvm with:
<ul>
<li>IP: 192.168.83.8</li>
<li>tapId: microvm6</li>
<li>mac: 02:00:00:00:00:07</li>
</ul>
</li>
</ul>
<p>Workspace:</p>
<ul>
<li>/home/michael/microvm/dcs/ - Workspace directory</li>
<li>/home/michael/microvm/dcs/ssh-host-keys/ - SSH host keys (ed25519)</li>
<li>/home/michael/microvm/dcs/dcs/ - Cloned repository from <a href="https://github.com/Debian/dcs" target="_blank" rel="noopener noreferrer">https://github.com/Debian/dcs</a></li>
</ul>
<p>Build verified - The configuration builds successfully.</p>
<p>To start the microvm after deploying:
<code>systemctl start microvm@dcsvm</code></p>
<p>To SSH into it:
<code>ssh michael@192.168.83.8</code></p>
</blockquote>
<p>Wonderful! In my experience, Claude always got the VM creation correct.</p>
<h2>Replicating this setup with Claude Code</h2>
<p>In fact, you can go one step further: Instead of just asking Claude to create
new MicroVMs, you can also ask Claude to replicate this entire setup into your
NixOS configuration!</p>
<p>Try a prompt like this:</p>
<blockquote>
<p>read
<a href="https://michael.stapelberg.ch/posts/2026-02-01-coding-agent-microvm-nix/" target="_blank" rel="noopener noreferrer">https://michael.stapelberg.ch/posts/2026-02-01-coding-agent-microvm-nix/</a>
— I want the exact same setup in my midna NixOS configuration please!</p>
</blockquote>
<h2>Conclusion</h2>
<p>NixOS has a reputation of being hard to adopt, but once you are using NixOS, you
can do powerful things like spinning up ephemeral MicroVMs for a new project
within minutes.</p>
<p>The maintenance effort is minimal: When I update my personal PC, my MicroVM
configurations start using the new software versions, too. Customization is easy
if needed.</p>
<p>This actually mirrors my experience with Coding Agents: I don’t feel like
they’re <em>automatically</em> making existing tasks more efficient, I feel that they
make things possible that were previously out of reach (similar to <a href="https://en.wikipedia.org/wiki/Jevons_paradox" target="_blank" rel="noopener noreferrer">Jevons
paradox</a>).</p>
<p>It was fascinating (and scary!) to experience the quality increase of Coding
Agents during 2025. At the beginning of 2025 I thought that LLMs are an
overhyped toy, and felt it was almost insulting when people showed me text or
code produced by these models. But almost every new frontier model release got
significantly better, and by now I have been positively surprised by Claude
Code’s capabilities and quality many times. It has produced code that handles
legitimate edge cases I would not have considered.</p>
<p>With this article, I showed one possible way to run Coding Agents safely (or any
workload that shouldn’t access your private data, really) that you can adjust in
many ways for your needs.</p>
</div> <footer class="article-footer" data-astro-cid-wrgicudb> <div class="action-row" data-astro-cid-wrgicudb> <a href="https://michael.stapelberg.ch/posts/2026-02-01-coding-agent-microvm-nix/" target="_blank" rel="noopener noreferrer" class="read-original-btn" data-astro-cid-wrgicudb>
阅读原文 ↗
</a> </div> <div class="back-to-list" data-astro-cid-wrgicudb> <a href="/reading-list" class="back-link" data-astro-cid-wrgicudb>← 返回订阅列表</a> </div> </footer> </article> </div>  </main> <footer class="site-footer" aria-label="Site footer" data-astro-cid-sz7xmlte> <div class="footer-content" data-astro-cid-sz7xmlte> <p class="footer-text" data-astro-cid-sz7xmlte>
&copy; 2026 AstroBlog
</p> <p class="footer-text" data-astro-cid-sz7xmlte>
Built with  <a href="https://astro.build/" target="_blank" rel="noopener noreferrer" class="footer-link" data-astro-cid-sz7xmlte>
Astro
</a> </p> </div> </footer>  </body></html> 
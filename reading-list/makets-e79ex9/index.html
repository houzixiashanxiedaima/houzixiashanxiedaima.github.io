<!DOCTYPE html><html lang="zh-CN" data-astro-cid-sckkx6r4> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v5.17.1"><meta name="description" content="make.ts
2026年1月27日
上 回车 上 上 回车 上 上 上 回车
听起来很熟悉？这就是我过去运行基准测试和其他实验的方式
需要重复一系列命令—输入"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self'; font-src 'self' data:;"><link rel="canonical" href="https://blog.yuyins.com/reading-list/makets-e79ex9/"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://blog.yuyins.com/reading-list/makets-e79ex9/"><meta property="og:title" content="make.ts"><meta property="og:description" content="make.ts
2026年1月27日
上 回车 上 上 回车 上 上 上 回车
听起来很熟悉？这就是我过去运行基准测试和其他实验的方式
需要重复一系列命令—输入"><meta property="og:image" content="https://blog.yuyins.com/favicon.svg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://blog.yuyins.com/reading-list/makets-e79ex9/"><meta property="twitter:title" content="make.ts"><meta property="twitter:description" content="make.ts
2026年1月27日
上 回车 上 上 回车 上 上 上 回车
听起来很熟悉？这就是我过去运行基准测试和其他实验的方式
需要重复一系列命令—输入"><meta property="twitter:image" content="https://blog.yuyins.com/favicon.svg"><title>make.ts</title><!-- Theme and color scheme script (runs before page loads to prevent flash) --><script>
			// 初始化配色方案 - 默认使用 stone-amber
			const colorScheme = localStorage.getItem('colorScheme') || 'stone-amber';
			document.documentElement.setAttribute('data-color', colorScheme);

			// 强制使用浅色主题
			document.documentElement.setAttribute('data-theme', 'light');
		</script><link rel="stylesheet" href="/_astro/_slug_.CIbPrqip.css">
<style>.blog-post-container[data-astro-cid-wrgicudb]{width:100%;margin:0 auto;padding:2rem 0}.blog-post[data-astro-cid-wrgicudb]{width:100%;min-width:0;max-width:42rem;margin:0 auto}.article-header[data-astro-cid-wrgicudb]{margin-bottom:2rem;padding-bottom:1rem;border-bottom:1px solid var(--border)}.article-header[data-astro-cid-wrgicudb] h1[data-astro-cid-wrgicudb]{font-size:2rem;line-height:1.3;margin-bottom:1rem;font-weight:700;color:var(--foreground);word-break:break-word}.article-meta[data-astro-cid-wrgicudb]{display:flex;align-items:center;gap:.5rem;font-size:.875rem;color:var(--muted-foreground)}.source-tag[data-astro-cid-wrgicudb]{background-color:var(--muted);color:var(--foreground);padding:.125rem .5rem;border-radius:9999px;font-weight:500;font-size:.75rem;text-decoration:none;transition:opacity .2s}.source-tag[data-astro-cid-wrgicudb]:hover{opacity:.8}.separator[data-astro-cid-wrgicudb]{color:var(--border)}.article-content[data-astro-cid-wrgicudb]{line-height:1.8;margin-bottom:3rem;font-size:1.0625rem;color:var(--foreground)}.article-content[data-astro-cid-wrgicudb] h2{margin-top:2rem;margin-bottom:1rem;font-size:1.5rem;font-weight:600}.article-content[data-astro-cid-wrgicudb] h3{margin-top:1.5rem;margin-bottom:.75rem;font-size:1.25rem;font-weight:600}.article-content[data-astro-cid-wrgicudb] p{margin-bottom:1.25rem}.article-content[data-astro-cid-wrgicudb] a{color:var(--accent);text-decoration:underline;text-underline-offset:2px}.article-content[data-astro-cid-wrgicudb] img{max-width:100%;height:auto;border-radius:.5rem;margin:1.5rem 0}.article-content[data-astro-cid-wrgicudb] blockquote{border-left:4px solid var(--border);padding-left:1rem;margin:1.5rem 0;color:var(--muted-foreground);font-style:italic}.article-content[data-astro-cid-wrgicudb] pre{background:var(--muted);padding:1rem;border-radius:.5rem;overflow-x:auto;font-family:monospace;margin:1.5rem 0}.article-content[data-astro-cid-wrgicudb] ul,.article-content[data-astro-cid-wrgicudb] ol{padding-left:1.5rem;margin-bottom:1.25rem}.article-content[data-astro-cid-wrgicudb] li{margin-bottom:.5rem}.article-footer[data-astro-cid-wrgicudb]{padding-top:2rem;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:1.5rem;align-items:center}.action-row[data-astro-cid-wrgicudb]{display:flex;justify-content:center}.read-original-btn[data-astro-cid-wrgicudb]{display:inline-flex;align-items:center;gap:.5rem;padding:.75rem 1.5rem;background-color:var(--foreground);color:var(--background);border-radius:.5rem;font-weight:500;text-decoration:none;transition:opacity .2s}.read-original-btn[data-astro-cid-wrgicudb]:hover{opacity:.9}.back-to-list[data-astro-cid-wrgicudb]{text-align:center}.back-link[data-astro-cid-wrgicudb]{color:var(--muted-foreground);text-decoration:none;font-size:.875rem;transition:color .2s}.back-link[data-astro-cid-wrgicudb]:hover{color:var(--foreground)}
</style></head> <body data-astro-cid-sckkx6r4> <a id="skip-to-content" href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:px-4 focus:py-2 focus:bg-accent focus:text-background" data-astro-cid-sckkx6r4>Skip to content</a> <header class="header" data-astro-cid-3ef6ksr2> <nav class="header-nav" aria-label="Main navigation" data-astro-cid-3ef6ksr2> <a href="/" class="header-logo" data-astro-cid-3ef6ksr2>
AstroBlog
</a> <div class="header-links" data-astro-cid-3ef6ksr2> <ul class="nav-list" data-astro-cid-3ef6ksr2> <li data-astro-cid-3ef6ksr2> <a href="/" class="nav-link" data-astro-prefetch="true" data-astro-cid-3ef6ksr2> 文章 </a> </li><li data-astro-cid-3ef6ksr2> <a href="/category" class="nav-link" data-astro-prefetch="true" data-astro-cid-3ef6ksr2> 分类 </a> </li><li data-astro-cid-3ef6ksr2> <a href="/reading-list" class="nav-link" data-astro-prefetch="true" data-astro-cid-3ef6ksr2> 订阅 </a> </li><li data-astro-cid-3ef6ksr2> <a href="/about" class="nav-link" data-astro-prefetch="true" data-astro-cid-3ef6ksr2> 关于 </a> </li> </ul> <div class="header-actions" data-astro-cid-3ef6ksr2> <div id="search" data-astro-cid-otpdt6jm> <button id="search-button" class="search-toggle" aria-label="打开搜索" title="搜索 (⌘K)" data-astro-cid-otpdt6jm> <svg class="search-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-astro-cid-otpdt6jm> <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2" stroke-linecap="round" data-astro-cid-otpdt6jm></circle> <path d="M20 20L16.5 16.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" data-astro-cid-otpdt6jm></path> </svg> </button> <dialog id="search-dialog" class="search-modal" data-astro-cid-otpdt6jm> <div class="modal-content" data-astro-cid-otpdt6jm> <div class="modal-header" data-astro-cid-otpdt6jm> <h2 class="modal-title" data-astro-cid-otpdt6jm>搜索文章</h2> <button id="close-search" class="close-button" aria-label="关闭搜索" data-astro-cid-otpdt6jm> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-astro-cid-otpdt6jm> <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-astro-cid-otpdt6jm></path> </svg> </button> </div> <div id="pagefind-ui" data-astro-cid-otpdt6jm></div> </div> </dialog> </div> <script type="module">let d=!1;const c="pagefind-loaded";async function l(t=0){if(sessionStorage.getItem(c)==="true")return g(),!0;const r=document.getElementById("pagefind-ui");if(!r)return!1;r.innerHTML='<div style="padding: 2rem; text-align: center; color: var(--muted-foreground);">加载中...</div>';try{return await new Promise((o,s)=>{const a=document.createElement("script");a.src="/pagefind/pagefind-ui.js",a.onload=o,a.onerror=s,document.head.appendChild(a)}),g(),sessionStorage.setItem(c,"true"),!0}catch(i){return console.error("Failed to load search:",i),t<2?(console.log(`Retrying search load... (${t+1}/2)`),await new Promise(o=>setTimeout(o,1e3)),l(t+1)):(r&&(r.innerHTML=`
          <div style="padding: 2rem; text-align: center;">
            <p style="color: var(--muted-foreground); margin-bottom: 1rem;">搜索功能加载失败</p>
            <button id="retry-search" style="padding: 0.5rem 1rem; background: var(--accent); color: var(--accent-foreground); border: none; border-radius: 0.375rem; cursor: pointer;">
              重试
            </button>
          </div>
        `,document.getElementById("retry-search")?.addEventListener("click",()=>{sessionStorage.removeItem(c),l(0)})),!1)}}function g(){typeof PagefindUI<"u"&&(new PagefindUI({element:"#pagefind-ui",showSubResults:!0,showImages:!1,excerptLength:15,translations:{placeholder:"搜索文章...",clear_search:"清除",load_more:"加载更多",search_label:"搜索此站点",filters_label:"筛选",zero_results:"未找到结果 [SEARCH_TERM]",many_results:"找到 [COUNT] 个结果 [SEARCH_TERM]",one_result:"找到 [COUNT] 个结果 [SEARCH_TERM]",alt_search:"未找到 [SEARCH_TERM] 的结果。显示 [DIFFERENT_TERM] 的结果",search_suggestion:"未找到 [SEARCH_TERM] 的结果。尝试以下搜索：",searching:"搜索中 [SEARCH_TERM]..."}}),setTimeout(()=>{const t=document.querySelector(".pagefind-ui__search-input");t instanceof HTMLElement&&t.focus()},100))}function u(){if(d)return;d=!0;const t=document.getElementById("search-button"),n=document.getElementById("search-dialog"),r=document.getElementById("close-search");if(!t||!n||!r)return;let i=sessionStorage.getItem(c)==="true";const o=async()=>{n.showModal(),document.body.style.overflow="hidden",i?setTimeout(()=>{const e=document.querySelector(".pagefind-ui__search-input");e instanceof HTMLElement&&e.focus()},100):await l()&&(i=!0)},s=()=>{n.close(),document.body.style.overflow=""},a=e=>{e.target===n&&s()},m=e=>{e.key==="Escape"&&n.open&&s()},f=e=>{(e.metaKey||e.ctrlKey)&&e.key==="k"&&(e.preventDefault(),n.open?s():o())};t.addEventListener("click",o),r.addEventListener("click",s),n.addEventListener("click",a),document.addEventListener("keydown",m),document.addEventListener("keydown",f),document.addEventListener("astro:before-swap",()=>{t.removeEventListener("click",o),r.removeEventListener("click",s),n.removeEventListener("click",a),document.removeEventListener("keydown",m),document.removeEventListener("keydown",f),d=!1},{once:!0})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",u):u();document.addEventListener("astro:page-load",u);</script> <link href="/pagefind/pagefind-ui.css" rel="stylesheet">  </div> </div> </nav> </header>  <main id="main-content" data-pagefind-body class="main-content main-content--wide" data-astro-cid-sckkx6r4>  <div class="blog-post-container" data-astro-cid-wrgicudb> <article class="blog-post" data-astro-cid-wrgicudb> <header class="article-header" data-astro-cid-wrgicudb> <h1 data-astro-cid-wrgicudb>make.ts</h1> <div class="article-meta" data-astro-cid-wrgicudb> <a href="https://matklad.github.io" target="_blank" rel="noopener noreferrer" class="source-tag" data-astro-cid-wrgicudb>matklad.github.io</a> <span class="separator" data-astro-cid-wrgicudb>·</span> <time data-astro-cid-wrgicudb>2026年1月27日</time> </div> </header> <!-- 使用清洗后的安全 HTML 内容 --> <div class="article-content app-prose" data-astro-cid-wrgicudb>
<header>
  <h1>make.ts</h1>
  <time>Jan 27, 2026</time>
</header>
<p><kbd><kbd>Up Enter</kbd></kbd> <kbd><kbd>Up Up Enter</kbd></kbd> <kbd><kbd>Up Up Up Enter</kbd></kbd></p>
<p>Sounds familiar? This is how I historically have been running benchmarks and other experiments
requiring a repeated sequence of commands — type them manually once, then rely on shell history
(and maybe some terminal splits) for reproduction. These past few years I’ve arrived at a much better
workflow pattern — <code>make.ts</code>. I was forced to adapt it once I started working with multiprocess
applications, where manually entering commands is borderline infeasible. In retrospect, I should
have adapted the workflow years earlier.</p>
<section>

<h2><a href="#The-Pattern" target="_blank" rel="noopener noreferrer">The Pattern</a></h2>
<p>Use a (gitignored) file for interactive scripting. Instead of entering a command directly into the
terminal, write it to a file first, and then run the file. For me, I type stuff into <code>make.ts</code> and
then run <code>./make.ts</code> in my terminal (Ok, I need <em>one</em> <kbd><kbd>Up Enter</kbd></kbd> for that).</p>
<p>I want to be clear here, I am not advocating writing “proper” scripts, just capturing your
interactive, ad-hoc command to a persistent file. Of course any command that you want to execute
<em>repeatedly</em> belongs to the build system. The surprising thing is that even more complex one-off
commands benefit from running through file, because it will take you several tries to get them
right!</p>
<p>There are many benefits relative to <kbd><kbd>Up Up Up</kbd></kbd> workflow:</p>
<ul>
<li>
Real commands tend to get large, and it is so much nicer to use a real 2D text editor rather than
shell’s line editor.
</li>
<li>
If you need more than one command, you can write several commands, and still run them all with a
single key (before <code>make.ts</code>, I was prone to constructing rather horrific &amp;&amp; conjuncts for this
reason).
</li>
<li>
With a sequence of command outlined, you nudge yourself towards incrementally improving them,
making them idempotent, and otherwise investing into your own workflow for the next few minutes,
without falling into the YAGNI pit from the outset.
</li>
<li>
At some point you might realize after, say, running a series of ad-hoc benchmarks interactively,
that you’d rather write a proper script which executes a collection of benchmarks with varying
parameters. With the file approach, you already have the meat of the script implemented, and you
only need to wrap in a couple of fors and ifs.
</li>
<li>
Finally, if you happen to work with multi-process projects, you’ll find it easier to manage
concurrency declaratively, spawning a tree of processes from a single script, rather than
switching between terminal splits.
</li>
</ul>
</section>
<section>

<h2><a href="#Details" target="_blank" rel="noopener noreferrer">Details</a></h2>
<p>Use a consistent filename for the script. I use <code>make.ts</code>, and so there’s a <code>make.ts</code> in the root
of most projects I work on. Correspondingly, I have <code>make.ts</code> line in project’s <code>.git/info/exclude</code>
— the <code>.gitignore</code> file which is not shared. The fixed name reduces fixed costs — whenever I
need complex interactivity I don’t need to come up with a name for a new file, I open my
pre-existing <code>make.ts</code>, wipe whatever was there and start hacking. Similarly, I have <code>./make.ts</code> in
my shell history, so
<a href="https://fishshell.com/docs/current/interactive.html#autosuggestions" target="_blank" rel="noopener noreferrer">fish autosuggestions</a>
work for me. At one point, I had a VS Code task to run <code>make.ts</code>, though I now use
<a href="https://matklad.github.io/2025/08/31/vibe-coding-terminal-editor.html" target="_blank" rel="noopener noreferrer">terminal editor</a>.</p>
<p>Start the script with hash bang,
<span><code>#!/usr/bin/env -S deno run --allow-all</code></span>
in my case, and
<span><code>chmod a+x make.ts</code></span>
the file, to make it easy to run.</p>
<p>Write the script in a language that:</p>
<ul>
<li>
you are comfortable with,
</li>
<li>
doesn’t require huge setup,
</li>
<li>
makes it easy to spawn subprocesses,
</li>
<li>
has good support for concurrency.
</li>
</ul>
<p>For me, that is TypeScript. Modern JavaScript is sufficiently ergonomic, and structural, gradual
typing is a sweet spot that gives you reasonable code completion, but still allows brute-forcing any
problem by throwing enough stringly dicts at it.</p>
<p>JavaScript’s tagged template syntax is brilliant for scripting use-cases:</p>

<figure>


<pre><code><span><span>function</span> <span>$</span>(<span>literal, ...interpolated</span>) {</span>
<span>  <span>console</span>.<span>log</span>({ literal, interpolated });</span>
<span>}</span>
<span></span>
<span><span>const</span> dir = <span>"hello, world"</span>;</span>
<span>$<span>`ls <span>${dir}</span>`</span>;</span></code></pre>

</figure>
<p>prints</p>

<figure>


<pre><code><span><span>{</span></span>
<span>    literal<span>:</span> <span>[</span> <span>"ls "</span><span>,</span> <span>""</span> <span>]</span><span>,</span></span>
<span>    interpolated<span>:</span> <span>[</span> <span>"hello, world"</span> <span>]</span></span>
<span><span>}</span></span></code></pre>

</figure>
<p>What happens here is that <code>$</code> gets a list of literal string fragments inside the backticks, and
then, separately, a list of values to be interpolated in-between. It <em>could</em> concatenate everything
to just a single string, but it doesn’t have to. This is precisely what is required for process
spawning, where you want to pass an array of strings to the <code>exec</code> syscall.</p>
<p>Specifically, I use <a href="https://github.com/dsherret/dax" target="_blank" rel="noopener noreferrer">dax</a> library with Deno, which is excellent as
a single-binary batteries-included scripting environment
(see <a href="https://matklad.github.io/2023/02/12/a-love-letter-to-deno.html" target="_blank" rel="noopener noreferrer">&lt;3 Deno</a>). Bun has a dax-like
library in the box and is a good alternative (though I personally stick with Deno because of
<code>deno fmt</code> and <code>deno lsp</code>). You could also use famous zx, though be mindful that it
<a href="https://google.github.io/zx/configuration#shell" target="_blank" rel="noopener noreferrer">uses your shell as a middleman</a>, something I
consider to be sloppy (<a href="https://julialang.org/blog/2012/03/shelling-out-sucks/" target="_blank" rel="noopener noreferrer">explanation</a>).</p>
<p>While <code>dax</code> makes it convenient to spawn a single program, <code>async/await</code> is excellent for herding a
slither of processes:</p>

<figure>


<pre><code><span><span>await</span> <span>Promise</span>.<span>all</span>([</span>
<span>    $<span>`sleep 5`</span>,</span>
<span>    $<span>`sleep 10`</span>,</span>
<span>]);</span></code></pre>

</figure>
</section>
<section>

<h2><a href="#Concrete-Example" target="_blank" rel="noopener noreferrer">Concrete Example</a></h2>
<p>Here’s how I applied this pattern earlier today. I wanted to measure how TigerBeetle cluster
recovers from the crash of the primary. The manual way to do that would be to create a bunch of ssh
sessions for several cloud machines, format datafiles, start replicas, and then create some load. I
<em>almost</em> started to split my terminal up, but then figured out I can do it the smart way.</p>
<p>The first step was cross-compiling the binary, uploading it to the cloud machines, and running the
cluster
(using my <a href="https://matklad.github.io/2026/01/20/vibecoding-2.html" target="_blank" rel="noopener noreferrer">box</a> from the other week):</p>

<figure>


<pre><code><span><span>#!/usr/bin/env -S deno run --allow-all</span></span>
<span><span>import</span> $ <span>from</span> <span>"jsr:@david/dax@0.44.2"</span>;</span>
<span></span>
<span><span>await</span> $<span>`./zig/zig build -Drelease -Dtarget=x86_64-linux`</span>;</span>
<span><span>await</span> $<span>`box sync 0-5 ./tigerbeetle`</span>;</span>
<span><span>await</span> $<span>`box run 0-5</span></span>
<span><span>    ./tigerbeetle format --cluster=0 --replica-count=6 --replica=?? 0_??.tigerbeetle`</span>;</span>
<span><span>await</span> $<span>`box run 0-5</span></span>
<span><span>    ./tigerbeetle start --addresses=?0-5? 0_??.tigerbeetle`</span>;</span></code></pre>

</figure>
<p>Running the above the second time, I realized that I need to kill the old cluster first, so two new
commands are “interactively” inserted:</p>

<figure>


<pre><code><span><span>await</span> $<span>`./zig/zig build -Drelease -Dtarget=x86_64-linux`</span>;</span>
<span><span>await</span> $<span>`box sync 0-5 ./tigerbeetle`</span>;</span>
<span></span>
<span><span>await</span> $<span>`box run 0-5 rm 0_??.tigerbeetle`</span>.<span>noThrow</span>();</span>
<span><span>await</span> $<span>`box run 0-5 pkill tigerbeetle`</span>.<span>noThrow</span>();</span>
<span></span>
<span><span>await</span> $<span>`box run 0-5</span></span>
<span><span>    ./tigerbeetle format --cluster=0 --replica-count=6 --replica=?? 0_??.tigerbeetle`</span>;</span>
<span><span>await</span> $<span>`box run 0-5</span></span>
<span><span>    ./tigerbeetle start --addresses=?0-5? 0_??.tigerbeetle`</span>;</span></code></pre>

</figure>
<p>At this point, my investment in writing this file and not just entering the commands one-by-one
already paid off!</p>
<p>The next step is to run the benchmark load in parallel with the cluster:</p>

<figure>


<pre><code><span><span>await</span> <span>Promise</span>.<span>all</span>([</span>
<span>    $<span>`box run 0-5 ./tigerbeetle start     --addresses=?0-5? 0_??.tigerbeetle`</span>,</span>
<span>    $<span>`box run 6   ./tigerbeetle benchmark --addresses=?0-5?`</span>,</span>
<span>])</span></code></pre>

</figure>
<p>I don’t need two terminals for two processes, and I get to copy-paste-edit the mostly same command.</p>
<p>For the next step, I actually want to kill one of the replicas, and I also want to capture live
logs, to see in real-time how the cluster reacts. This is where <code>0-5</code> multiplexing syntax of box
falls short, but, given that this is JavaScript, I can just write a for loop:</p>

<figure>


<pre><code><span><span>const</span> replicas = <span>range</span>(<span>6</span>).<span>map</span>(<span>(<span>it</span>) =&gt;</span></span>
<span>    $<span>`box run <span>${it}</span></span></span>
<span><span>        ./tigerbeetle start --addresses=?0-5? 0_??.tigerbeetle</span></span>
<span><span>        &amp;&gt; logs/<span>${it}</span>.log`</span></span>
<span>        .<span>noThrow</span>()</span>
<span>        .<span>spawn</span>()</span>
<span>);</span>
<span></span>
<span><span>await</span> <span>Promise</span>.<span>all</span>([</span>
<span>    $<span>`box run 6 ./tigerbeetle benchmark --addresses=?0-5?`</span>,</span>
<span>    (<span>async</span> () =&gt; {</span>
<span>        <span>await</span> $.<span>sleep</span>(<span>"20s"</span>);</span>
<span>        <span>console</span>.<span>log</span>(<span>"REDRUM"</span>);</span>
<span>        <span>await</span> $<span>`box run 1 pkill tigerbeetle`</span>;</span>
<span>    })(),</span>
<span>]);</span>
<span></span>
<span>replicas.<span>forEach</span>(<span>(<span>it</span>) =&gt;</span> it.<span>kill</span>());</span>
<span><span>await</span> <span>Promise</span>.<span>all</span>(replicas);</span></code></pre>

</figure>
<p>At this point, I do need two terminals. One runs <code>./make.ts</code> and shows the log from the benchmark
itself, the other runs <code>tail -f logs/2.log</code> to watch the next replica to become primary.</p>
<p>I have definitelly crossed the line where writing a script makes sense, but the neat thing is that
the gradual evolution up to this point. There isn’t a discontinuity where I need to spend 15
minutes trying to shape various ad-hoc commands from five terminals into a single coherent script, it
was in the file to begin with.</p>
<p>And then the script is easy to evolve. Once you realize that it’s a good idea to also run the same
benchmark against a different, baseline version TigerBeetle, you replace <code>./tigerbeetle</code> with
<code>./${tigerbeetle}</code> and wrap everything into</p>

<figure>


<pre><code><span><span>async</span> <span>function</span> <span>benchmark</span>(<span>tigerbeetle: <span>string</span></span>) {</span>
<span>    <span>// ...</span></span>
<span>}</span>
<span></span>
<span><span>const</span> tigerbeetle = <span>Deno</span>.<span>args</span>[<span>0</span>]</span>
<span><span>await</span> <span>benchmark</span>(tigerbeetle);</span></code></pre>

</figure>

<figure>


<pre><code><span><span>$</span> ./make.ts tigerbeetle-baseline</span>
<span><span>$</span> ./make.ts tigerbeetle</span></code></pre>

</figure>
<p>A bit more hacking, and you end up with a repeatable benchmark schedule for a matrix of parameters:</p>

<figure>


<pre><code><span><span>for</span> (<span>const</span> attempt <span>of</span> [<span>0</span>, <span>1</span>])</span>
<span><span>for</span> (<span>const</span> tigerbeetle <span>of</span> [<span>"baseline"</span>, <span>"tigerbeetle"</span>])</span>
<span><span>for</span> (<span>const</span> mode <span>of</span> [<span>"normal"</span>, <span>"viewchange"</span>]) {</span>
<span>    <span>const</span> results = $.<span>path</span>(</span>
<span>        <span>`./results/<span>${tigerbeetle}</span>-<span>${mode}</span>-<span>${attempt}</span>`</span>,</span>
<span>    );</span>
<span>    <span>await</span> <span>benchmark</span>(tigerbeetle, mode, results);</span>
<span>}</span></code></pre>

</figure>
<p>That’s the gist of it. Don’t let the shell history be your source, capture it into the file first!</p>
</section>
</div> <footer class="article-footer" data-astro-cid-wrgicudb> <div class="action-row" data-astro-cid-wrgicudb> <a href="https://matklad.github.io/2026/01/27/make-ts.html" target="_blank" rel="noopener noreferrer" class="read-original-btn" data-astro-cid-wrgicudb>
阅读原文 ↗
</a> </div> <div class="back-to-list" data-astro-cid-wrgicudb> <a href="/reading-list" class="back-link" data-astro-cid-wrgicudb>← 返回订阅列表</a> </div> </footer> </article> </div>  </main> <footer class="site-footer" aria-label="Site footer" data-astro-cid-sz7xmlte> <div class="footer-content" data-astro-cid-sz7xmlte> <p class="footer-text" data-astro-cid-sz7xmlte>
&copy; 2026 AstroBlog
</p> <p class="footer-text" data-astro-cid-sz7xmlte>
Built with  <a href="https://astro.build/" target="_blank" rel="noopener noreferrer" class="footer-link" data-astro-cid-sz7xmlte>
Astro
</a> </p> </div> </footer>  </body></html> 
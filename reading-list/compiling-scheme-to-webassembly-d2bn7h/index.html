<!DOCTYPE html><html lang="zh-CN" data-astro-cid-sckkx6r4> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v5.17.1"><meta name="description" content="我最古老的开源项目之一——Bob，几个月前刚刚庆祝了它的 15 岁生日。Bob 是一个用 Python 实现的 Scheme 编程语言的套件，包括一个解释器和一个编译器。"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self'; font-src 'self' data:;"><link rel="canonical" href="https://blog.yuyins.com/reading-list/compiling-scheme-to-webassembly-d2bn7h/"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://blog.yuyins.com/reading-list/compiling-scheme-to-webassembly-d2bn7h/"><meta property="og:title" content="将 Scheme 编译为 WebAssembly"><meta property="og:description" content="我最古老的开源项目之一——Bob，几个月前刚刚庆祝了它的 15 岁生日。Bob 是一个用 Python 实现的 Scheme 编程语言的套件，包括一个解释器和一个编译器。"><meta property="og:image" content="https://blog.yuyins.com/favicon.svg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://blog.yuyins.com/reading-list/compiling-scheme-to-webassembly-d2bn7h/"><meta property="twitter:title" content="将 Scheme 编译为 WebAssembly"><meta property="twitter:description" content="我最古老的开源项目之一——Bob，几个月前刚刚庆祝了它的 15 岁生日。Bob 是一个用 Python 实现的 Scheme 编程语言的套件，包括一个解释器和一个编译器。"><meta property="twitter:image" content="https://blog.yuyins.com/favicon.svg"><title>将 Scheme 编译为 WebAssembly</title><!-- Theme and color scheme script (runs before page loads to prevent flash) --><script>
			// 初始化配色方案 - 默认使用 stone-amber
			const colorScheme = localStorage.getItem('colorScheme') || 'stone-amber';
			document.documentElement.setAttribute('data-color', colorScheme);

			// 强制使用浅色主题
			document.documentElement.setAttribute('data-theme', 'light');
		</script><link rel="stylesheet" href="/_astro/_slug_.AC5XNt97.css">
<style>.blog-post-container[data-astro-cid-wrgicudb]{width:100%;margin:0 auto;padding:2rem 0}.blog-post[data-astro-cid-wrgicudb]{width:100%;min-width:0;max-width:42rem;margin:0 auto}.article-header[data-astro-cid-wrgicudb]{margin-bottom:2rem;padding-bottom:1rem;border-bottom:1px solid var(--border)}.article-header[data-astro-cid-wrgicudb] h1[data-astro-cid-wrgicudb]{font-size:2rem;line-height:1.3;margin-bottom:1rem;font-weight:700;color:var(--foreground);word-break:break-word}.article-meta[data-astro-cid-wrgicudb]{display:flex;align-items:center;gap:.5rem;font-size:.875rem;color:var(--muted-foreground)}.source-tag[data-astro-cid-wrgicudb]{background-color:var(--muted);color:var(--foreground);padding:.125rem .5rem;border-radius:9999px;font-weight:500;font-size:.75rem;text-decoration:none;transition:opacity .2s}.source-tag[data-astro-cid-wrgicudb]:hover{opacity:.8}.separator[data-astro-cid-wrgicudb]{color:var(--border)}.article-content[data-astro-cid-wrgicudb]{line-height:1.8;margin-bottom:3rem;font-size:1.0625rem;color:var(--foreground)}.article-content[data-astro-cid-wrgicudb] h2{margin-top:2rem;margin-bottom:1rem;font-size:1.5rem;font-weight:600}.article-content[data-astro-cid-wrgicudb] h3{margin-top:1.5rem;margin-bottom:.75rem;font-size:1.25rem;font-weight:600}.article-content[data-astro-cid-wrgicudb] p{margin-bottom:1.25rem}.article-content[data-astro-cid-wrgicudb] a{color:var(--accent);text-decoration:underline;text-underline-offset:2px}.article-content[data-astro-cid-wrgicudb] img{max-width:100%;height:auto;border-radius:.5rem;margin:1.5rem 0}.article-content[data-astro-cid-wrgicudb] blockquote{border-left:4px solid var(--border);padding-left:1rem;margin:1.5rem 0;color:var(--muted-foreground);font-style:italic}.article-content[data-astro-cid-wrgicudb] pre{background:var(--muted);padding:1rem;border-radius:.5rem;overflow-x:auto;font-family:monospace;margin:1.5rem 0}.article-content[data-astro-cid-wrgicudb] ul,.article-content[data-astro-cid-wrgicudb] ol{padding-left:1.5rem;margin-bottom:1.25rem}.article-content[data-astro-cid-wrgicudb] li{margin-bottom:.5rem}.article-footer[data-astro-cid-wrgicudb]{padding-top:2rem;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:1.5rem;align-items:center}.action-row[data-astro-cid-wrgicudb]{display:flex;justify-content:center}.read-original-btn[data-astro-cid-wrgicudb]{display:inline-flex;align-items:center;gap:.5rem;padding:.75rem 1.5rem;background-color:var(--foreground);color:var(--background);border-radius:.5rem;font-weight:500;text-decoration:none;transition:opacity .2s}.read-original-btn[data-astro-cid-wrgicudb]:hover{opacity:.9}.back-to-list[data-astro-cid-wrgicudb]{text-align:center}.back-link[data-astro-cid-wrgicudb]{color:var(--muted-foreground);text-decoration:none;font-size:.875rem;transition:color .2s}.back-link[data-astro-cid-wrgicudb]:hover{color:var(--foreground)}
</style></head> <body data-astro-cid-sckkx6r4> <a id="skip-to-content" href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:px-4 focus:py-2 focus:bg-accent focus:text-background" data-astro-cid-sckkx6r4>Skip to content</a> <header class="header" data-astro-cid-3ef6ksr2> <nav class="header-nav" aria-label="Main navigation" data-astro-cid-3ef6ksr2> <a href="/" class="header-logo" data-astro-cid-3ef6ksr2>
AstroBlog
</a> <div class="header-links" data-astro-cid-3ef6ksr2> <ul class="nav-list" data-astro-cid-3ef6ksr2> <li data-astro-cid-3ef6ksr2> <a href="/" class="nav-link" data-astro-prefetch="true" data-astro-cid-3ef6ksr2> 文章 </a> </li><li data-astro-cid-3ef6ksr2> <a href="/category" class="nav-link" data-astro-prefetch="true" data-astro-cid-3ef6ksr2> 分类 </a> </li><li data-astro-cid-3ef6ksr2> <a href="/reading-list" class="nav-link" data-astro-prefetch="true" data-astro-cid-3ef6ksr2> 订阅 </a> </li><li data-astro-cid-3ef6ksr2> <a href="/about" class="nav-link" data-astro-prefetch="true" data-astro-cid-3ef6ksr2> 关于 </a> </li> </ul> <div class="header-actions" data-astro-cid-3ef6ksr2> <div id="search" data-astro-cid-otpdt6jm> <button id="search-button" class="search-toggle" aria-label="打开搜索" title="搜索 (⌘K)" data-astro-cid-otpdt6jm> <svg class="search-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-astro-cid-otpdt6jm> <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2" stroke-linecap="round" data-astro-cid-otpdt6jm></circle> <path d="M20 20L16.5 16.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" data-astro-cid-otpdt6jm></path> </svg> </button> <dialog id="search-dialog" class="search-modal" data-astro-cid-otpdt6jm> <div class="modal-content" data-astro-cid-otpdt6jm> <div class="modal-header" data-astro-cid-otpdt6jm> <h2 class="modal-title" data-astro-cid-otpdt6jm>搜索文章</h2> <button id="close-search" class="close-button" aria-label="关闭搜索" data-astro-cid-otpdt6jm> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-astro-cid-otpdt6jm> <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-astro-cid-otpdt6jm></path> </svg> </button> </div> <div id="pagefind-ui" data-astro-cid-otpdt6jm></div> </div> </dialog> </div> <script type="module">let d=!1;const c="pagefind-loaded";async function l(t=0){if(sessionStorage.getItem(c)==="true")return g(),!0;const r=document.getElementById("pagefind-ui");if(!r)return!1;r.innerHTML='<div style="padding: 2rem; text-align: center; color: var(--muted-foreground);">加载中...</div>';try{return await new Promise((o,s)=>{const a=document.createElement("script");a.src="/pagefind/pagefind-ui.js",a.onload=o,a.onerror=s,document.head.appendChild(a)}),g(),sessionStorage.setItem(c,"true"),!0}catch(i){return console.error("Failed to load search:",i),t<2?(console.log(`Retrying search load... (${t+1}/2)`),await new Promise(o=>setTimeout(o,1e3)),l(t+1)):(r&&(r.innerHTML=`
          <div style="padding: 2rem; text-align: center;">
            <p style="color: var(--muted-foreground); margin-bottom: 1rem;">搜索功能加载失败</p>
            <button id="retry-search" style="padding: 0.5rem 1rem; background: var(--accent); color: var(--accent-foreground); border: none; border-radius: 0.375rem; cursor: pointer;">
              重试
            </button>
          </div>
        `,document.getElementById("retry-search")?.addEventListener("click",()=>{sessionStorage.removeItem(c),l(0)})),!1)}}function g(){typeof PagefindUI<"u"&&(new PagefindUI({element:"#pagefind-ui",showSubResults:!0,showImages:!1,excerptLength:15,translations:{placeholder:"搜索文章...",clear_search:"清除",load_more:"加载更多",search_label:"搜索此站点",filters_label:"筛选",zero_results:"未找到结果 [SEARCH_TERM]",many_results:"找到 [COUNT] 个结果 [SEARCH_TERM]",one_result:"找到 [COUNT] 个结果 [SEARCH_TERM]",alt_search:"未找到 [SEARCH_TERM] 的结果。显示 [DIFFERENT_TERM] 的结果",search_suggestion:"未找到 [SEARCH_TERM] 的结果。尝试以下搜索：",searching:"搜索中 [SEARCH_TERM]..."}}),setTimeout(()=>{const t=document.querySelector(".pagefind-ui__search-input");t instanceof HTMLElement&&t.focus()},100))}function u(){if(d)return;d=!0;const t=document.getElementById("search-button"),n=document.getElementById("search-dialog"),r=document.getElementById("close-search");if(!t||!n||!r)return;let i=sessionStorage.getItem(c)==="true";const o=async()=>{n.showModal(),document.body.style.overflow="hidden",i?setTimeout(()=>{const e=document.querySelector(".pagefind-ui__search-input");e instanceof HTMLElement&&e.focus()},100):await l()&&(i=!0)},s=()=>{n.close(),document.body.style.overflow=""},a=e=>{e.target===n&&s()},m=e=>{e.key==="Escape"&&n.open&&s()},f=e=>{(e.metaKey||e.ctrlKey)&&e.key==="k"&&(e.preventDefault(),n.open?s():o())};t.addEventListener("click",o),r.addEventListener("click",s),n.addEventListener("click",a),document.addEventListener("keydown",m),document.addEventListener("keydown",f),document.addEventListener("astro:before-swap",()=>{t.removeEventListener("click",o),r.removeEventListener("click",s),n.removeEventListener("click",a),document.removeEventListener("keydown",m),document.removeEventListener("keydown",f),d=!1},{once:!0})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",u):u();document.addEventListener("astro:page-load",u);</script> <link href="/pagefind/pagefind-ui.css" rel="stylesheet">  </div> </div> </nav> </header>  <main id="main-content" data-pagefind-body class="main-content main-content--wide" data-astro-cid-sckkx6r4>  <div class="blog-post-container" data-astro-cid-wrgicudb> <article class="blog-post" data-astro-cid-wrgicudb> <header class="article-header" data-astro-cid-wrgicudb> <h1 data-astro-cid-wrgicudb>将 Scheme 编译为 WebAssembly</h1> <div class="article-meta" data-astro-cid-wrgicudb> <a href="https://eli.thegreenplace.net" target="_blank" rel="noopener noreferrer" class="source-tag" data-astro-cid-wrgicudb>eli.thegreenplace.net</a> <span class="separator" data-astro-cid-wrgicudb>·</span> <time data-astro-cid-wrgicudb>2026年1月17日</time> </div> </header> <!-- 使用清洗后的安全 HTML 内容 --> <div class="article-content app-prose" data-astro-cid-wrgicudb><p>One of my oldest open-source projects - <a href="https://github.com/eliben/bobscheme" target="_blank" rel="noopener noreferrer">Bob</a>
- has <a href="https://eli.thegreenplace.net/2010/11/06/bob-a-scheme-interpreter-compiler-and-vm-in-python" target="_blank" rel="noopener noreferrer">celebrated 15 a couple of months ago</a>.
Bob is a suite of implementations of the Scheme programming language in Python,
including an interpreter, a compiler and a VM. Back then I was doing some hacking
on CPython internals and was very curious about how CPython-like bytecode VMs
work; Bob was an experiment to find out, by implementing one from scratch for
R5RS Scheme.</p>
<p>Several months later I <a href="https://eli.thegreenplace.net/2011/04/09/a-c-vm-added-to-bob" target="_blank" rel="noopener noreferrer">added a C++ VM to Bob</a>,
as an exercise to learn how such VMs are implemented in a low-level language
without all the runtime support Python provides; most importantly, without the
built-in GC. The C++ VM in Bob implements its own mark-and-sweep GC.</p>
<p>After many quiet years (with just a sprinkling of cosmetic changes, porting to
GitHub, updates to Python 3, etc), I felt the itch to work on Bob again just
before the holidays. Specifically, I decided to add another compiler to the
suite - this one from Scheme directly to WebAssembly.</p>
<p>The goals of this effort were two-fold:</p>
<ol>
<li>Experiment with lowering a real, high-level language like Scheme to
WebAssembly. Experiments like the recent <a href="https://eli.thegreenplace.net/2025/revisiting-lets-build-a-compiler/" target="_blank" rel="noopener noreferrer">Let's Build a Compiler</a>
compile toy languages that are at the C level (no runtime). Scheme has built-in
data structures, lexical closures, garbage collection, etc. It's much more challenging.</li>
<li>Get some hands-on experience with the WASM GC extension <a href="#footnote-1" target="_blank" rel="noopener noreferrer">[1]</a>. I have several
samples of using WASM GC in the <a href="https://github.com/eliben/wasm-wat-samples" target="_blank" rel="noopener noreferrer">wasm-wat-samples repository</a>,
but I really wanted to try it for something "real".</li>
</ol>
<p>Well, it's done now; here's an updated schematic of the Bob project:</p>
<img alt="Bob project diagram with all the components it includes" src="https://eli.thegreenplace.net/images/2026/bob_toplevel.png" />
<p>The new part is the rightmost vertical path. A <a href="https://github.com/eliben/bobscheme/blob/main/bob/wasmcompiler.py" target="_blank" rel="noopener noreferrer">WasmCompiler</a>
class lowers parsed Scheme expressions all the way down to WebAssembly text,
which can then be compiled to a binary and executed using standard WASM tools <a href="#footnote-2" target="_blank" rel="noopener noreferrer">[2]</a>.</p>
<div>
<h2>Highlights</h2>
<p>The most interesting aspect of this project was working with WASM GC to
represent Scheme objects. As long as we properly box/wrap all values in
refs, the underlying WASM execution environment will take care of the
memory management.</p>
<p>For Bob, here's how some key Scheme objects are represented:</p>
<div><pre><span></span>;; PAIR holds the car and cdr of a cons cell.
(type $PAIR (struct (field (mut (ref null eq))) (field (mut (ref null eq)))))

;; BOOL represents a Scheme boolean. zero -&gt; false, nonzero -&gt; true.
(type $BOOL (struct (field i32)))

;; SYMBOL represents a Scheme symbol. It holds an offset in linear memory
;; and the length of the symbol name.
(type $SYMBOL (struct (field i32) (field i32)))
</pre></div>
<p>$PAIR is of particular interest, as it may contain arbitrary objects in
its fields; (ref null eq) means "a nullable reference to something that
has identity". ref.test can be used to check - for a given
reference - the run-time type of the value it refers to.</p>
<p>You may wonder - what about numeric values? Here WASM has a trick - the i31
type can be used to represent a reference to an integer, but without
actually boxing it (one bit is used to distinguish such an object from a
real reference). So we don't need a separate type to hold references to numbers.</p>
<p>Also, the $SYMBOL type looks unusual - how is it represented with two
numbers? The key to the mystery is that WASM has no built-in support for
strings; they should be implemented manually using offsets to linear memory.
The Bob WASM compiler emits the string values of all symbols encountered into
linear memory, keeping track of the offset and length of each one; these are
the two numbers placed in $SYMBOL. This also allows to fairly easily
implement the string interning feature of Scheme; multiple instances of the
same symbol will only be allocated once.</p>
<p>Consider this trivial Scheme snippet:</p>
<div><pre><span></span><span>(</span><span>write</span><span> </span><span>'</span><span>(</span><span>10</span><span> </span><span>20</span><span> </span><span>foo</span><span> </span><span>bar</span><span>))</span><span></span>
</pre></div>
<p>The compiler emits the symbols "foo" and "bar" into linear memory as follows <a href="#footnote-3" target="_blank" rel="noopener noreferrer">[3]</a>:</p>
<div><pre><span></span>(data (i32.const 2048) "foo")
(data (i32.const 2051) "bar")
</pre></div>
<p>And looking for one of these addresses in the rest of the emitted code, we'll
find:</p>
<div><pre><span></span>(struct.new $SYMBOL (i32.const 2051) (i32.const 3))
</pre></div>
<p>As part of the code for constructing the constant cons list representing the
argument to write; address 2051 and length 3: this is the symbol bar.</p>
<p>Speaking of write, implementing this builtin was quite interesting. For
compatibility with the other Bob implementations in my repository, write
needs to be able to print recursive representations of arbitrary Scheme values,
including lists, symbols, etc.</p>
<p>Initially I was reluctant to implement all of this functionality by hand in
WASM text, but all alternatives ran into challenges:</p>
<ol>
<li>Deferring this to the host is difficult because the host environment has
no access to WASM GC references - they are completely opaque.</li>
<li>Implementing it in another language (maybe C?) and lowering to WASM is also
challenging for a similar reason - the other language is unlikely to have
a good representation of WASM GC objects.</li>
</ol>
<p>So I bit the bullet and - with some AI help for the tedious parts - just wrote
an implementation of write directly in WASM text; it wasn't really that
bad. I import only two functions from the host:</p>
<div><pre><span></span>(import "env" "write_char" (func $write_char (param i32)))
(import "env" "write_i32" (func $write_i32 (param i32)))
</pre></div>
<p>Though emitting integers <a href="https://eli.thegreenplace.net/2023/itoa-integer-to-string-in-webassembly/" target="_blank" rel="noopener noreferrer">directly from WASM isn't hard</a>,
I figured this project already has enough code and some host help here would
be welcome. For all the rest, only the lowest level write_char is used.
For example, here's how booleans are emitted in the canonical Scheme notation
(#t and #f):</p>
<div><pre><span></span>(func $emit_bool (param $b (ref $BOOL))
    (call $emit (i32.const 35)) ;; '#'
    (if (i32.eqz (struct.get $BOOL 0 (local.get $b)))
        (then (call $emit (i32.const 102))) ;; 'f'
        (else (call $emit (i32.const 116))) ;; 't'
    )
)
</pre></div>
</div>
<div>
<h2>Conclusion</h2>
<p>This was a really fun project, and I learned quite a bit about realistic code
emission to WASM. Feel free to check out the source code of <a href="https://github.com/eliben/bobscheme/blob/main/bob/wasmcompiler.py" target="_blank" rel="noopener noreferrer">WasmCompiler</a> - it's
very well documented. While it's a bit over 1000 LOC in total <a href="#footnote-4" target="_blank" rel="noopener noreferrer">[4]</a>, more than half
of that is actually WASM text snippets that implement the builtin types and
functions needed by a basic Scheme implementation.</p>
<hr />
<table>
<colgroup><col></col><col></col></colgroup>
<tbody>
<tr><td><a href="#footnote-reference-1" target="_blank" rel="noopener noreferrer">[1]</a></td><td>The GC proposal <a href="https://github.com/WebAssembly/gc" target="_blank" rel="noopener noreferrer">is documented here</a>.
It was officially added to the WASM spec in Oct 2023.</td></tr>
</tbody>
</table>
<table>
<colgroup><col></col><col></col></colgroup>
<tbody>
<tr><td><a href="#footnote-reference-2" target="_blank" rel="noopener noreferrer">[2]</a></td><td><p>In Bob this is currently done with <span>bytecodealliance/wasm-tools</span> for the
text-to-binary conversion and Node.js for the execution environment, but
this can change in the future.</p>
<p>I actually wanted to use Python bindings to wasmtime, but these don't
appear to support WASM GC yet.</p>
</td></tr>
</tbody>
</table>
<table>
<colgroup><col></col><col></col></colgroup>
<tbody>
<tr><td><a href="#footnote-reference-3" target="_blank" rel="noopener noreferrer">[3]</a></td><td>2048 is just an arbitrary offset the compiler uses as the beginning of
the section for symbols in memory. We could
also use the multiple memories feature of WASM and dedicate a separate
linear memory just for symbols.</td></tr>
</tbody>
</table>
<table>
<colgroup><col></col><col></col></colgroup>
<tbody>
<tr><td><a href="#footnote-reference-4" target="_blank" rel="noopener noreferrer">[4]</a></td><td>To be clear, this is just the WASM compiler class; it uses the Expr
representation of Scheme that is created by Bob's parser (and lexer);
the code of these other components is shared among all Bob
implementations and isn't counted here.</td></tr>
</tbody>
</table>
</div>
</div> <footer class="article-footer" data-astro-cid-wrgicudb> <div class="action-row" data-astro-cid-wrgicudb> <a href="https://eli.thegreenplace.net/2026/compiling-scheme-to-webassembly/" target="_blank" rel="noopener noreferrer" class="read-original-btn" data-astro-cid-wrgicudb>
阅读原文 ↗
</a> </div> <div class="back-to-list" data-astro-cid-wrgicudb> <a href="/reading-list" class="back-link" data-astro-cid-wrgicudb>← 返回订阅列表</a> </div> </footer> </article> </div>  </main> <footer class="site-footer" aria-label="Site footer" data-astro-cid-sz7xmlte> <div class="footer-content" data-astro-cid-sz7xmlte> <p class="footer-text" data-astro-cid-sz7xmlte>
&copy; 2026 AstroBlog
</p> <p class="footer-text" data-astro-cid-sz7xmlte>
Built with  <a href="https://astro.build/" target="_blank" rel="noopener noreferrer" class="footer-link" data-astro-cid-sz7xmlte>
Astro
</a> </p> </div> </footer>  </body></html> 
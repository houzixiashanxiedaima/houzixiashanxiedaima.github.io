<!DOCTYPE html><html lang="zh-CN" data-astro-cid-sckkx6r4> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v5.17.1"><meta name="description" content="你的任务（如果你选择接受的话）是潜入启动过程的最早期阶段，在不破坏任何东西的情况下交换启动配置，然后不留痕迹地离开。准备好了吗？"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self'; font-src 'self' data:;"><link rel="canonical" href="https://blog.yuyins.com/reading-list/remotely-unlocking-an-encrypted-hard-disk-ytjzw8/"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://blog.yuyins.com/reading-list/remotely-unlocking-an-encrypted-hard-disk-ytjzw8/"><meta property="og:title" content="远程解锁加密硬盘"><meta property="og:description" content="你的任务（如果你选择接受的话）是潜入启动过程的最早期阶段，在不破坏任何东西的情况下交换启动配置，然后不留痕迹地离开。准备好了吗？"><meta property="og:image" content="https://blog.yuyins.com/favicon.svg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://blog.yuyins.com/reading-list/remotely-unlocking-an-encrypted-hard-disk-ytjzw8/"><meta property="twitter:title" content="远程解锁加密硬盘"><meta property="twitter:description" content="你的任务（如果你选择接受的话）是潜入启动过程的最早期阶段，在不破坏任何东西的情况下交换启动配置，然后不留痕迹地离开。准备好了吗？"><meta property="twitter:image" content="https://blog.yuyins.com/favicon.svg"><title>远程解锁加密硬盘</title><!-- Theme and color scheme script (runs before page loads to prevent flash) --><script>
			// 初始化配色方案 - 默认使用 stone-amber
			const colorScheme = localStorage.getItem('colorScheme') || 'stone-amber';
			document.documentElement.setAttribute('data-color', colorScheme);

			// 强制使用浅色主题
			document.documentElement.setAttribute('data-theme', 'light');
		</script><link rel="stylesheet" href="/_astro/_slug_.ChsEGtcr.css">
<style>.blog-post-container[data-astro-cid-wrgicudb]{width:100%;margin:0 auto;padding:2rem 0}.blog-post[data-astro-cid-wrgicudb]{width:100%;min-width:0;max-width:42rem;margin:0 auto}.article-header[data-astro-cid-wrgicudb]{margin-bottom:2rem;padding-bottom:1rem;border-bottom:1px solid var(--border)}.article-header[data-astro-cid-wrgicudb] h1[data-astro-cid-wrgicudb]{font-size:2rem;line-height:1.3;margin-bottom:1rem;font-weight:700;color:var(--foreground);word-break:break-word}.article-meta[data-astro-cid-wrgicudb]{display:flex;align-items:center;gap:.5rem;font-size:.875rem;color:var(--muted-foreground)}.source-tag[data-astro-cid-wrgicudb]{background-color:var(--muted);color:var(--foreground);padding:.125rem .5rem;border-radius:9999px;font-weight:500;font-size:.75rem;text-decoration:none;transition:opacity .2s}.source-tag[data-astro-cid-wrgicudb]:hover{opacity:.8}.separator[data-astro-cid-wrgicudb]{color:var(--border)}.article-content[data-astro-cid-wrgicudb]{line-height:1.8;margin-bottom:3rem;font-size:1.0625rem;color:var(--foreground)}.article-content[data-astro-cid-wrgicudb] h2{margin-top:2rem;margin-bottom:1rem;font-size:1.5rem;font-weight:600}.article-content[data-astro-cid-wrgicudb] h3{margin-top:1.5rem;margin-bottom:.75rem;font-size:1.25rem;font-weight:600}.article-content[data-astro-cid-wrgicudb] p{margin-bottom:1.25rem}.article-content[data-astro-cid-wrgicudb] a{color:var(--accent);text-decoration:underline;text-underline-offset:2px}.article-content[data-astro-cid-wrgicudb] img{max-width:100%;height:auto;border-radius:.5rem;margin:1.5rem 0}.article-content[data-astro-cid-wrgicudb] blockquote{border-left:4px solid var(--border);padding-left:1rem;margin:1.5rem 0;color:var(--muted-foreground);font-style:italic}.article-content[data-astro-cid-wrgicudb] pre{background:var(--muted);padding:1rem;border-radius:.5rem;overflow-x:auto;font-family:monospace;margin:1.5rem 0}.article-content[data-astro-cid-wrgicudb] ul,.article-content[data-astro-cid-wrgicudb] ol{padding-left:1.5rem;margin-bottom:1.25rem}.article-content[data-astro-cid-wrgicudb] li{margin-bottom:.5rem}.article-footer[data-astro-cid-wrgicudb]{padding-top:2rem;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:1.5rem;align-items:center}.action-row[data-astro-cid-wrgicudb]{display:flex;justify-content:center}.read-original-btn[data-astro-cid-wrgicudb]{display:inline-flex;align-items:center;gap:.5rem;padding:.75rem 1.5rem;background-color:var(--foreground);color:var(--background);border-radius:.5rem;font-weight:500;text-decoration:none;transition:opacity .2s}.read-original-btn[data-astro-cid-wrgicudb]:hover{opacity:.9}.back-to-list[data-astro-cid-wrgicudb]{text-align:center}.back-link[data-astro-cid-wrgicudb]{color:var(--muted-foreground);text-decoration:none;font-size:.875rem;transition:color .2s}.back-link[data-astro-cid-wrgicudb]:hover{color:var(--foreground)}
</style></head> <body data-astro-cid-sckkx6r4> <a id="skip-to-content" href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:px-4 focus:py-2 focus:bg-accent focus:text-background" data-astro-cid-sckkx6r4>Skip to content</a> <header class="header" data-astro-cid-3ef6ksr2> <nav class="header-nav" aria-label="Main navigation" data-astro-cid-3ef6ksr2> <a href="/" class="header-logo" data-astro-cid-3ef6ksr2>
AstroBlog
</a> <div class="header-links" data-astro-cid-3ef6ksr2> <ul class="nav-list" data-astro-cid-3ef6ksr2> <li data-astro-cid-3ef6ksr2> <a href="/" class="nav-link" data-astro-prefetch="true" data-astro-cid-3ef6ksr2> 文章 </a> </li><li data-astro-cid-3ef6ksr2> <a href="/category" class="nav-link" data-astro-prefetch="true" data-astro-cid-3ef6ksr2> 分类 </a> </li><li data-astro-cid-3ef6ksr2> <a href="/reading-list" class="nav-link" data-astro-prefetch="true" data-astro-cid-3ef6ksr2> 订阅 </a> </li><li data-astro-cid-3ef6ksr2> <a href="/about" class="nav-link" data-astro-prefetch="true" data-astro-cid-3ef6ksr2> 关于 </a> </li> </ul> <div class="header-actions" data-astro-cid-3ef6ksr2> <div id="search" data-astro-cid-otpdt6jm> <button id="search-button" class="search-toggle" aria-label="打开搜索" title="搜索 (⌘K)" data-astro-cid-otpdt6jm> <svg class="search-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-astro-cid-otpdt6jm> <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2" stroke-linecap="round" data-astro-cid-otpdt6jm></circle> <path d="M20 20L16.5 16.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" data-astro-cid-otpdt6jm></path> </svg> </button> <dialog id="search-dialog" class="search-modal" data-astro-cid-otpdt6jm> <div class="modal-content" data-astro-cid-otpdt6jm> <div class="modal-header" data-astro-cid-otpdt6jm> <h2 class="modal-title" data-astro-cid-otpdt6jm>搜索文章</h2> <button id="close-search" class="close-button" aria-label="关闭搜索" data-astro-cid-otpdt6jm> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-astro-cid-otpdt6jm> <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-astro-cid-otpdt6jm></path> </svg> </button> </div> <div id="pagefind-ui" data-astro-cid-otpdt6jm></div> </div> </dialog> </div> <script type="module">let d=!1;const c="pagefind-loaded";async function l(t=0){if(sessionStorage.getItem(c)==="true")return g(),!0;const r=document.getElementById("pagefind-ui");if(!r)return!1;r.innerHTML='<div style="padding: 2rem; text-align: center; color: var(--muted-foreground);">加载中...</div>';try{return await new Promise((o,s)=>{const a=document.createElement("script");a.src="/pagefind/pagefind-ui.js",a.onload=o,a.onerror=s,document.head.appendChild(a)}),g(),sessionStorage.setItem(c,"true"),!0}catch(i){return console.error("Failed to load search:",i),t<2?(console.log(`Retrying search load... (${t+1}/2)`),await new Promise(o=>setTimeout(o,1e3)),l(t+1)):(r&&(r.innerHTML=`
          <div style="padding: 2rem; text-align: center;">
            <p style="color: var(--muted-foreground); margin-bottom: 1rem;">搜索功能加载失败</p>
            <button id="retry-search" style="padding: 0.5rem 1rem; background: var(--accent); color: var(--accent-foreground); border: none; border-radius: 0.375rem; cursor: pointer;">
              重试
            </button>
          </div>
        `,document.getElementById("retry-search")?.addEventListener("click",()=>{sessionStorage.removeItem(c),l(0)})),!1)}}function g(){typeof PagefindUI<"u"&&(new PagefindUI({element:"#pagefind-ui",showSubResults:!0,showImages:!1,excerptLength:15,translations:{placeholder:"搜索文章...",clear_search:"清除",load_more:"加载更多",search_label:"搜索此站点",filters_label:"筛选",zero_results:"未找到结果 [SEARCH_TERM]",many_results:"找到 [COUNT] 个结果 [SEARCH_TERM]",one_result:"找到 [COUNT] 个结果 [SEARCH_TERM]",alt_search:"未找到 [SEARCH_TERM] 的结果。显示 [DIFFERENT_TERM] 的结果",search_suggestion:"未找到 [SEARCH_TERM] 的结果。尝试以下搜索：",searching:"搜索中 [SEARCH_TERM]..."}}),setTimeout(()=>{const t=document.querySelector(".pagefind-ui__search-input");t instanceof HTMLElement&&t.focus()},100))}function u(){if(d)return;d=!0;const t=document.getElementById("search-button"),n=document.getElementById("search-dialog"),r=document.getElementById("close-search");if(!t||!n||!r)return;let i=sessionStorage.getItem(c)==="true";const o=async()=>{n.showModal(),document.body.style.overflow="hidden",i?setTimeout(()=>{const e=document.querySelector(".pagefind-ui__search-input");e instanceof HTMLElement&&e.focus()},100):await l()&&(i=!0)},s=()=>{n.close(),document.body.style.overflow=""},a=e=>{e.target===n&&s()},m=e=>{e.key==="Escape"&&n.open&&s()},f=e=>{(e.metaKey||e.ctrlKey)&&e.key==="k"&&(e.preventDefault(),n.open?s():o())};t.addEventListener("click",o),r.addEventListener("click",s),n.addEventListener("click",a),document.addEventListener("keydown",m),document.addEventListener("keydown",f),document.addEventListener("astro:before-swap",()=>{t.removeEventListener("click",o),r.removeEventListener("click",s),n.removeEventListener("click",a),document.removeEventListener("keydown",m),document.removeEventListener("keydown",f),d=!1},{once:!0})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",u):u();document.addEventListener("astro:page-load",u);</script> <link href="/pagefind/pagefind-ui.css" rel="stylesheet">  </div> </div> </nav> </header>  <main id="main-content" data-pagefind-body class="main-content main-content--wide" data-astro-cid-sckkx6r4>  <div class="blog-post-container" data-astro-cid-wrgicudb> <article class="blog-post" data-astro-cid-wrgicudb> <header class="article-header" data-astro-cid-wrgicudb> <h1 data-astro-cid-wrgicudb>远程解锁加密硬盘</h1> <div class="article-meta" data-astro-cid-wrgicudb> <a href="https://jyn.dev" target="_blank" rel="noopener noreferrer" class="source-tag" data-astro-cid-wrgicudb>jyn.dev</a> <span class="separator" data-astro-cid-wrgicudb>·</span> <time data-astro-cid-wrgicudb>2026年1月22日</time> </div> </header> <!-- 使用清洗后的安全 HTML 内容 --> <div class="article-content app-prose" data-astro-cid-wrgicudb><p>Your mission, should you choose to accept it, is to sneak into the earliest parts of the boot process, swap the startup config without breaking anything, and leave without a trace.</p>
<p>Are you ready? Let's begin.</p>
<h2>the setup<a href="#the-setup" target="_blank" rel="noopener noreferrer"></a>
</h2>
<p><em>In which our heroes are introduced, and the scene is set.</em></p>
<p>For a very long time I had a beat-up old ThinkPad that couldn’t hold a charge for the life of it, especially when running Windows. It tended to die a lot when I was traveling, and I travel a lot. To save battery when I’m away from home, I often ssh back into my home desktop, both so I have persistent state even if my laptop battery dies, and so I get much faster builds that don’t kill the battery.</p>
<p>This has two small problems:</p>
<ol>
<li>Sometimes my home loses power and the desktop shuts off.</li>
<li>Sometimes when the power comes back on it has a new public IP.</li>
</ol>
<p>For a long time I solved 1. by enabling “Power On" after "Restore AC Power Loss” in the BIOS and 2. with <a href="https://tailscale.com/kb/1151/what-is-tailscale" target="_blank" rel="noopener noreferrer">tailscale</a>. However, I recently installed Arch with an encrypted boot partition, which means that boot doesn’t finish until I type in the encryption password.</p>
<p>Well. Well. What if I Simply put tailscale in initramfs?</p>
<h2>the plan<a href="#the-plan" target="_blank" rel="noopener noreferrer"></a>
</h2>
<p><em>In which our intrepid heroes chart the challenges to come.</em></p>
<h3>initramfs<a href="#initramfs" target="_blank" rel="noopener noreferrer"></a>
</h3>
<p>Oh, right. If you weren’t aware, early boot in a Linux operating system<sup><a href="#fn-3" target="_blank" rel="noopener noreferrer">1</a></sup>  is just running a full second operating system that happens to be very small, lol. That’s loaded from a compressed archive file in /boot<sup><a href="#fn-4" target="_blank" rel="noopener noreferrer">2</a></sup> and run from memory, with no access to persistent storage. This OS running from memory is called <strong>initramfs</strong> (initial RAM filesystem).</p>
<p>So when you see a screen like this:
<img src="/assets/Pasted%20image%2020260121044155.png" alt="" />
That’s actually a whole-ass OS, with an <code>init</code> PID and service management and everything. This is how, for example, <code>systemd-analyze</code> can show you stats about early boot — there’s another copy of systemd running in initramfs, and it passes its state off to the one in the main OS.</p>
<p>Well. That implies we can install things on it ^^.</p>
<h3>constraints<a href="#constraints" target="_blank" rel="noopener noreferrer"></a>
</h3>
<p>There’s three parts to this:</p>
<ol>
<li>Networking in initramfs</li>
<li>Tailscale in initramfs</li>
<li>SSH in initramfs</li>
</ol>
<p>We also want to make this as secure as possible, so there’s some more things to consider:</p>
<ul>
<li>Putting tailscale in initramfs means that it has unencrypted keys lying around.</li>
<li>Tailscale keys expire (by default) after 90 days. At that point this will all break.</li>
<li>You really really don’t want people to get SSH access to your early boot environment.</li>
</ul>
<p>We can solve this in a few ways:</p>
<ul>
<li>Use Tailscale ACLs to only allow incoming connections to initramfs, not outgoing connections.</li>
<li>Set the key to never expire.</li>
<li>Set the SSH server to disallow all shells except the actual unlock command (<code>systemd-tty-ask-password-agent</code>).</li>
</ul>
<h3>tailscale ACLs<a href="#tailscale-acls" target="_blank" rel="noopener noreferrer"></a>
</h3>
<p>Some background about Tailscale’s ACLs (“access control lists”). Tailscale’s users are tied to their specific login method: you can, for example, add a passkey, but that passkey counts as a fully separate user than your original account. Tailscale also has “groups” of users, which are what they sound like, “<a href="https://tailscale.com/kb/1396/targets#autogroups" target="_blank" rel="noopener noreferrer">auto groups</a>”, which again are what they sound like, “hosts”, which are a machine connected to the network, and “tags”.</p>
<p>Tags are odd, I haven't seen anything like them before. They group hosts, not users, and when you add a tag to a host, that <em>counts as its login method</em>, rather than the host being tied to a user account.</p>
<p>A consequence of this is that the group <a href="https://tailscale.com/kb/1396/targets#autogrouprole" target="_blank" rel="noopener noreferrer"><code>autogroup:member</code></a> does <em>not</em> include tagged machines, because tagged machines aren’t tied to a user account. (A second consequence is that you can’t remove all tags from a machine without logging out and logging back in to associate it with your user account.)</p>
<p>So we can write a policy like this:</p>
<pre><code><span><span><span>{</span>
</span></span><span><span>  <span><span>//</span> Define the tags which can be applied to devices and by which users.
</span></span></span><span><span>  </span><span><span><span>"</span>tagOwners<span>"</span></span></span><span><span>:</span> </span><span><span><span>{</span>
</span></span></span><span><span><span>    </span><span><span><span>"</span>tag:initrd<span>"</span></span></span><span><span>:</span> </span><span><span><span>[</span><span><span>"</span>autogroup:admin<span>"</span></span><span>]</span></span><span>,</span>
</span></span></span><span><span><span>  <span>}</span></span><span>,</span>
</span></span><span><span>
</span></span><span><span>  <span><span>//</span> Define access control lists for users, groups, autogroups, tags,
</span></span></span><span><span>  <span><span>//</span> Tailscale IP addresses, and subnet ranges.
</span></span></span><span><span>  </span><span><span><span>"</span>acls<span>"</span></span></span><span><span>:</span> </span><span><span><span>[</span>
</span></span></span><span><span><span>    <span><span>{</span></span><span><span><span>"</span>action<span>"</span></span></span><span><span>:</span> </span><span><span><span>"</span>accept<span>"</span></span><span>,</span> </span><span><span><span>"</span>src<span>"</span></span></span><span><span>:</span> </span><span><span><span>[</span><span><span>"</span>autogroup:member<span>"</span></span><span>]</span></span><span>,</span> </span><span><span><span>"</span>dst<span>"</span></span></span><span><span>:</span> </span><span><span><span>[</span><span><span>"</span>*:*<span>"</span></span><span>]</span></span><span>}</span></span><span>,</span>
</span></span></span><span><span><span>  <span>]</span></span><span>,</span>
</span></span><span><span>
</span></span><span><span>  <span><span>//</span> Test access rules every time they're saved.
</span></span></span><span><span>  </span><span><span><span>"</span>tests<span>"</span></span></span><span><span>:</span> </span><span><span><span>[</span>
</span></span></span><span><span><span>    <span><span>{</span>
</span></span></span></span><span><span><span><span>      </span><span><span><span>"</span>src<span>"</span></span></span><span><span>:</span>    </span><span><span><span>"</span>100.76.34.8<span>"</span></span><span>,</span> <span><span>//</span> outrageous-fortune
</span></span></span></span></span><span><span><span><span>      </span><span><span><span>"</span>accept<span>"</span></span></span><span><span>:</span> </span><span><span><span>[</span><span><span>"</span>100.102.101.127:22<span>"</span></span><span>,</span> <span><span>"</span>100.101.55.73:10078<span>"</span></span><span>]</span></span><span>,</span> <span><span>//</span> selene-initrd
</span></span></span></span></span><span><span><span><span>    <span>}</span></span><span>,</span>
</span></span></span><span><span><span>    <span><span>{</span>
</span></span></span></span><span><span><span><span>      </span><span><span><span>"</span>src<span>"</span></span></span><span><span>:</span>  </span><span><span><span>"</span>100.102.101.127<span>"</span></span><span>,</span> <span><span>//</span> selene-initrd
</span></span></span></span></span><span><span><span><span>      </span><span><span><span>"</span>deny<span>"</span></span></span><span><span>:</span> </span><span><span><span>[</span><span><span>"</span>100.101.55.73:10078<span>"</span></span><span>]</span></span><span>,</span> <span><span>//</span> selene
</span></span></span></span></span><span><span><span><span>    <span>}</span></span><span>,</span>
</span></span></span><span><span><span>  <span>]</span></span><span>,</span>
</span></span><span><span><span>}</span></span>
</span></code></pre>
<p>This says “allow devices tied to a user account to access any other device, and allow no permissions at all for devices tied to a tag”.</p>
<p><code>selene</code> here is my desktop, and <code>selene-initrd</code> is its initramfs.  <sup><a href="#fn-1" target="_blank" rel="noopener noreferrer">3</a></sup></p>
<h3>systemd before boot<a href="#systemd-before-boot" target="_blank" rel="noopener noreferrer"></a>
</h3>
<p>Because initramfs is just a (mostly) normal Linux system, that means it has its own <code>init</code>
PID 1. On Arch, that PID is in fact just systemd. That means that we can add systemd
services to initramfs! There's a whole collection of them in
<a href="https://github.com/wolegis/mkinitcpio-systemd-extras" target="_blank" rel="noopener noreferrer"><code>mkinitcpio-systemd-extras</code></a>
(<code>mkinitcpio</code> is the tool Arch uses to regenerate initramfs).</p>
<p>We need two services: an SSH server (I went with
<a href="https://github.com/wolegis/mkinitcpio-systemd-extras/wiki/Dropbear-SSH-server" target="_blank" rel="noopener noreferrer"><code>dropbear</code></a>)
and something to turn on networking, which this collection names <code>sd-network</code>.</p>
<aside><div>
<p>It's possible to run <code>tailscale ssh</code> directly, rather than having a separate SSH server, but
I didn't find any way to configure tailscale's SSH command, and I don't want to let anyone
have a shell in my initramfs.</p>
</div></aside>
<h2>the heist<a href="#the-heist" target="_blank" rel="noopener noreferrer"></a>
</h2>
<p><em>In which our heroes execute their plan flawlessly, sneaking in without a sound.</em></p>
<p>If you follow these steps on an Arch system, you should end up with roughly the same setup
as I have. Most of these commands assume you are running as root.</p>
<ul>
<li>
<p>Install the dropbear SSH server:</p>
<pre><code><span><span><span>pacman</span></span><span><span><span> -</span>S</span> dropbear</span>
</span></code></pre>
</li>
<li>
<p>Install the systemd packages:</p>
<pre><code><span><span><span>yay</span></span><span><span><span> -</span>S</span> mkinitcpio-systemd-extras mkinitcpio-tailscale</span>
</span></code></pre>
</li>
<li>
<p>Add networking (<code>sd-network</code>), tailscale (<code>tailscale</code>), and dropbear (<code>sd-dropbear</code>) to
<code>/etc/mkinitcpio.conf</code>:</p>
<pre><code><span><span><span>1c1
</span></span></span><span><span><span>&lt;</span> HOOKS=(base systemd autodetect microcode kms modconf block keyboard sd-vconsole plymouth sd-encrypt filesystems)
</span></span><span><span><span>---</span>
</span></span><span><span><span>&gt;</span> HOOKS=(base systemd autodetect microcode kms modconf block keyboard sd-vconsole plymouth sd-network tailscale sd-dropbear sd-encrypt filesystems)
</span></span></code></pre>
</li>
<li>
<p>Set up the keys for your new tailscale device:</p>
<pre><code><span><span><span>setup-initcpio-tailscale</span></span>
</span></code></pre>
</li>
<li>
<p>In <a href="https://login.tailscale.com/admin/machines" target="_blank" rel="noopener noreferrer">the tailscale web console</a>, mark your new
device with <code>tag:initrd</code>, and disable key expiry. It should look something like this:</p>
<p><img src="/assets/Pasted%20image%2020260121213235.png" alt="" /></p>
</li>
<li>
<p>In <code>/etc/mkinitcpio.conf</code>, configure dropbear to only allow running the unlock command and nothing else:</p>
<pre><code><span><span>SD_DROPBEAR_COMMAND</span><span>=</span><span><span><span>"</span>systemd-tty-ask-password-agent<span>"</span></span></span>
</span></code></pre>
</li>
<li>
<p>Tell systemd to wait forever for a decryption password. I use <code>systemd-boot</code>, so I edited
<code>/boot/loader/entries/linux-cachyos</code>. Under <code>options</code>, I extended the existing
<code>rootflags=subvol=/@</code> to <code>rootflags=subvol=/@,x-systemd.device-timeout=0</code>. <sup><a href="#fn-2" target="_blank" rel="noopener noreferrer">4</a></sup></p>
</li>
<li>
<p>Copy your public keys into <code>/root/.ssh/authorized_keys</code> so they get picked up by the
dropbear hook:</p>
<pre><code><span><span><span>cp</span></span><span> <span><span>~</span></span>/.ssh/authorized_keys /root/.ssh/</span>
</span></code></pre>
</li>
<li>
<p>Generate a new public/private keypair for use by the dropbear server.</p>
<pre><code><span><span><span>dropbearkey</span></span><span><span><span> -</span>t</span> ed25519<span><span> -</span>f</span> /etc/dropbear/dropbear_ed25519_host_key</span>
</span></code></pre>
</li>
</ul>
<aside><div>
<p>Without this, the dropbear hook will try to load keys from openssh, which means they'll be shared between early boot and your normal server. In particular that would mean your SSH server private keys would be stored unencrypted in initramfs.</p>
</div></aside>
<ul>
<li>
<p>Setup early networking.
(Note: these instructions are only for Ethernet connections. If you want WiFi in early
boot, good luck and godspeed.)</p>
<ol>
<li>Add the following config in <code>/etc/systemd/network-initramfs/10-wired.network</code>:</li>
</ol>
<pre><code><span><span>[Match]
</span></span><span><span><span>Type</span><span>=</span></span>ether
</span><span>
</span><span><span>[Network]
</span></span><span><span>DHCP</span><span>=</span><span>yes</span>
</span></code></pre>
<ol>
<li>Register it in <code>/etc/mkinitcpio.conf</code> so it gets picked up by the <code>sd-network</code> hook:</li>
</ol>
<pre><code><span><span>SD_NETWORK_CONFIG</span><span>=</span><span>/etc/systemd/network-initramfs</span>
</span></code></pre>
<p>All this rigamarole is necessary because the OS doesn't set the network interfaces to
predictable names until late boot, so it needs some way to know which interface to use.</p>
</li>
<li>
<p>Last but not least, rebuild your initramfs: <code>mkinitcpio -P</code>.</p>
</li>
</ul>
<p>Next time you reboot, you should be able to ssh into <code>$(hostname)-initrd</code> and get a prompt
that looks like this:</p>
<p><img src="/assets/Screenshot_20260121_222102.png" alt="" /></p>
<h2>the getaway<a href="#the-getaway" target="_blank" rel="noopener noreferrer"></a>
</h2>
<p><em>In which a moral is imparted, and our scene concluded.</em></p>
<p>The takeaway here is the same as in all my other posts: if you think something isn't
possible to do with a computer, have you considered applying more violence?</p>
<section>
<ol>
<li>
<p>and I believe in Windows, although I’m less sure about that <a href="#fr-3-1" target="_blank" rel="noopener noreferrer">↩</a></p>
</li>
<li>
<p>sometimes /boot/EFI <a href="#fr-4-1" target="_blank" rel="noopener noreferrer">↩</a></p>
</li>
<li>
<p>Here “initrd” stands for “initramdisk”, which is another word for our initramfs system. <a href="#fr-1-1" target="_blank" rel="noopener noreferrer">↩</a></p>
</li>
<li>
<p>See <a href="https://github.com/wolegis/mkinitcpio-systemd-extras/wiki/Dropbear-SSH-server#:~:text=systemd%2Edevice%2Dtimeout" target="_blank" rel="noopener noreferrer">the <code>sd-dropbear</code>
docs</a> for more information about this. <a href="#fr-2-1" target="_blank" rel="noopener noreferrer">↩</a></p>
</li>
</ol>
</section>
</div> <footer class="article-footer" data-astro-cid-wrgicudb> <div class="action-row" data-astro-cid-wrgicudb> <a href="https://jyn.dev/remotely-unlocking-an-encrypted-hard-disk/" target="_blank" rel="noopener noreferrer" class="read-original-btn" data-astro-cid-wrgicudb>
阅读原文 ↗
</a> </div> <div class="back-to-list" data-astro-cid-wrgicudb> <a href="/reading-list" class="back-link" data-astro-cid-wrgicudb>← 返回订阅列表</a> </div> </footer> </article> </div>  </main> <footer class="site-footer" aria-label="Site footer" data-astro-cid-sz7xmlte> <div class="footer-content" data-astro-cid-sz7xmlte> <p class="footer-text" data-astro-cid-sz7xmlte>
&copy; 2026 AstroBlog
</p> <p class="footer-text" data-astro-cid-sz7xmlte>
Built with  <a href="https://astro.build/" target="_blank" rel="noopener noreferrer" class="footer-link" data-astro-cid-sz7xmlte>
Astro
</a> </p> </div> </footer>  </body></html> 
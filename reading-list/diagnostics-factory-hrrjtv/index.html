<!DOCTYPE html><html lang="zh-CN" data-astro-cid-sckkx6r4> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v5.17.1"><meta name="description" content="诊断工厂
2026年2月16日
在《控制流中的错误代码》中，我解释了 Zig 的强类型错误代码解决了错误管理的“处理”部分，而“报告”则留给用户。为了"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self'; font-src 'self' data:;"><link rel="canonical" href="https://blog.yuyins.com/reading-list/diagnostics-factory-hrrjtv/"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://blog.yuyins.com/reading-list/diagnostics-factory-hrrjtv/"><meta property="og:title" content="诊断工厂"><meta property="og:description" content="诊断工厂
2026年2月16日
在《控制流中的错误代码》中，我解释了 Zig 的强类型错误代码解决了错误管理的“处理”部分，而“报告”则留给用户。为了"><meta property="og:image" content="https://blog.yuyins.com/favicon.svg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://blog.yuyins.com/reading-list/diagnostics-factory-hrrjtv/"><meta property="twitter:title" content="诊断工厂"><meta property="twitter:description" content="诊断工厂
2026年2月16日
在《控制流中的错误代码》中，我解释了 Zig 的强类型错误代码解决了错误管理的“处理”部分，而“报告”则留给用户。为了"><meta property="twitter:image" content="https://blog.yuyins.com/favicon.svg"><title>诊断工厂</title><!-- Theme and color scheme script (runs before page loads to prevent flash) --><script>
			// 初始化配色方案 - 默认使用 stone-amber
			const colorScheme = localStorage.getItem('colorScheme') || 'stone-amber';
			document.documentElement.setAttribute('data-color', colorScheme);

			// 强制使用浅色主题
			document.documentElement.setAttribute('data-theme', 'light');
		</script><link rel="stylesheet" href="/_astro/_slug_.BK6BiV5P.css">
<style>.blog-post-container[data-astro-cid-wrgicudb]{width:100%;margin:0 auto;padding:2rem 0}.blog-post[data-astro-cid-wrgicudb]{width:100%;min-width:0;max-width:42rem;margin:0 auto}.article-header[data-astro-cid-wrgicudb]{margin-bottom:2rem;padding-bottom:1rem;border-bottom:1px solid var(--border)}.article-header[data-astro-cid-wrgicudb] h1[data-astro-cid-wrgicudb]{font-size:2rem;line-height:1.3;margin-bottom:1rem;font-weight:700;color:var(--foreground);word-break:break-word}.article-meta[data-astro-cid-wrgicudb]{display:flex;align-items:center;gap:.5rem;font-size:.875rem;color:var(--muted-foreground)}.source-tag[data-astro-cid-wrgicudb]{background-color:var(--muted);color:var(--foreground);padding:.125rem .5rem;border-radius:9999px;font-weight:500;font-size:.75rem;text-decoration:none;transition:opacity .2s}.source-tag[data-astro-cid-wrgicudb]:hover{opacity:.8}.separator[data-astro-cid-wrgicudb]{color:var(--border)}.article-content[data-astro-cid-wrgicudb]{line-height:1.8;margin-bottom:3rem;font-size:1.0625rem;color:var(--foreground)}.article-content[data-astro-cid-wrgicudb] h2{margin-top:2rem;margin-bottom:1rem;font-size:1.5rem;font-weight:600}.article-content[data-astro-cid-wrgicudb] h3{margin-top:1.5rem;margin-bottom:.75rem;font-size:1.25rem;font-weight:600}.article-content[data-astro-cid-wrgicudb] p{margin-bottom:1.25rem}.article-content[data-astro-cid-wrgicudb] a{color:var(--accent);text-decoration:underline;text-underline-offset:2px}.article-content[data-astro-cid-wrgicudb] img{max-width:100%;height:auto;border-radius:.5rem;margin:1.5rem 0}.article-content[data-astro-cid-wrgicudb] blockquote{border-left:4px solid var(--border);padding-left:1rem;margin:1.5rem 0;color:var(--muted-foreground);font-style:italic}.article-content[data-astro-cid-wrgicudb] pre{background:var(--muted);padding:1rem;border-radius:.5rem;overflow-x:auto;font-family:monospace;margin:1.5rem 0}.article-content[data-astro-cid-wrgicudb] ul,.article-content[data-astro-cid-wrgicudb] ol{padding-left:1.5rem;margin-bottom:1.25rem}.article-content[data-astro-cid-wrgicudb] li{margin-bottom:.5rem}.article-footer[data-astro-cid-wrgicudb]{padding-top:2rem;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:1.5rem;align-items:center}.action-row[data-astro-cid-wrgicudb]{display:flex;justify-content:center}.read-original-btn[data-astro-cid-wrgicudb]{display:inline-flex;align-items:center;gap:.5rem;padding:.75rem 1.5rem;background-color:var(--foreground);color:var(--background);border-radius:.5rem;font-weight:500;text-decoration:none;transition:opacity .2s}.read-original-btn[data-astro-cid-wrgicudb]:hover{opacity:.9}.back-to-list[data-astro-cid-wrgicudb]{text-align:center}.back-link[data-astro-cid-wrgicudb]{color:var(--muted-foreground);text-decoration:none;font-size:.875rem;transition:color .2s}.back-link[data-astro-cid-wrgicudb]:hover{color:var(--foreground)}
</style></head> <body data-astro-cid-sckkx6r4> <a id="skip-to-content" href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:px-4 focus:py-2 focus:bg-accent focus:text-background" data-astro-cid-sckkx6r4>Skip to content</a> <header class="header" data-astro-cid-3ef6ksr2> <nav class="header-nav" aria-label="Main navigation" data-astro-cid-3ef6ksr2> <a href="/" class="header-logo" data-astro-cid-3ef6ksr2>
AstroBlog
</a> <div class="header-links" data-astro-cid-3ef6ksr2> <ul class="nav-list" data-astro-cid-3ef6ksr2> <li data-astro-cid-3ef6ksr2> <a href="/" class="nav-link" data-astro-prefetch="true" data-astro-cid-3ef6ksr2> 文章 </a> </li><li data-astro-cid-3ef6ksr2> <a href="/category" class="nav-link" data-astro-prefetch="true" data-astro-cid-3ef6ksr2> 分类 </a> </li><li data-astro-cid-3ef6ksr2> <a href="/reading-list" class="nav-link" data-astro-prefetch="true" data-astro-cid-3ef6ksr2> 订阅 </a> </li><li data-astro-cid-3ef6ksr2> <a href="/about" class="nav-link" data-astro-prefetch="true" data-astro-cid-3ef6ksr2> 关于 </a> </li> </ul> <div class="header-actions" data-astro-cid-3ef6ksr2> <div id="search" data-astro-cid-otpdt6jm> <button id="search-button" class="search-toggle" aria-label="打开搜索" title="搜索 (⌘K)" data-astro-cid-otpdt6jm> <svg class="search-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-astro-cid-otpdt6jm> <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2" stroke-linecap="round" data-astro-cid-otpdt6jm></circle> <path d="M20 20L16.5 16.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" data-astro-cid-otpdt6jm></path> </svg> </button> <dialog id="search-dialog" class="search-modal" data-astro-cid-otpdt6jm> <div class="modal-content" data-astro-cid-otpdt6jm> <div class="modal-header" data-astro-cid-otpdt6jm> <h2 class="modal-title" data-astro-cid-otpdt6jm>搜索文章</h2> <button id="close-search" class="close-button" aria-label="关闭搜索" data-astro-cid-otpdt6jm> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-astro-cid-otpdt6jm> <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-astro-cid-otpdt6jm></path> </svg> </button> </div> <div id="pagefind-ui" data-astro-cid-otpdt6jm></div> </div> </dialog> </div> <script type="module">let d=!1;const c="pagefind-loaded";async function l(t=0){if(sessionStorage.getItem(c)==="true")return g(),!0;const r=document.getElementById("pagefind-ui");if(!r)return!1;r.innerHTML='<div style="padding: 2rem; text-align: center; color: var(--muted-foreground);">加载中...</div>';try{return await new Promise((o,s)=>{const a=document.createElement("script");a.src="/pagefind/pagefind-ui.js",a.onload=o,a.onerror=s,document.head.appendChild(a)}),g(),sessionStorage.setItem(c,"true"),!0}catch(i){return console.error("Failed to load search:",i),t<2?(console.log(`Retrying search load... (${t+1}/2)`),await new Promise(o=>setTimeout(o,1e3)),l(t+1)):(r&&(r.innerHTML=`
          <div style="padding: 2rem; text-align: center;">
            <p style="color: var(--muted-foreground); margin-bottom: 1rem;">搜索功能加载失败</p>
            <button id="retry-search" style="padding: 0.5rem 1rem; background: var(--accent); color: var(--accent-foreground); border: none; border-radius: 0.375rem; cursor: pointer;">
              重试
            </button>
          </div>
        `,document.getElementById("retry-search")?.addEventListener("click",()=>{sessionStorage.removeItem(c),l(0)})),!1)}}function g(){typeof PagefindUI<"u"&&(new PagefindUI({element:"#pagefind-ui",showSubResults:!0,showImages:!1,excerptLength:15,translations:{placeholder:"搜索文章...",clear_search:"清除",load_more:"加载更多",search_label:"搜索此站点",filters_label:"筛选",zero_results:"未找到结果 [SEARCH_TERM]",many_results:"找到 [COUNT] 个结果 [SEARCH_TERM]",one_result:"找到 [COUNT] 个结果 [SEARCH_TERM]",alt_search:"未找到 [SEARCH_TERM] 的结果。显示 [DIFFERENT_TERM] 的结果",search_suggestion:"未找到 [SEARCH_TERM] 的结果。尝试以下搜索：",searching:"搜索中 [SEARCH_TERM]..."}}),setTimeout(()=>{const t=document.querySelector(".pagefind-ui__search-input");t instanceof HTMLElement&&t.focus()},100))}function u(){if(d)return;d=!0;const t=document.getElementById("search-button"),n=document.getElementById("search-dialog"),r=document.getElementById("close-search");if(!t||!n||!r)return;let i=sessionStorage.getItem(c)==="true";const o=async()=>{n.showModal(),document.body.style.overflow="hidden",i?setTimeout(()=>{const e=document.querySelector(".pagefind-ui__search-input");e instanceof HTMLElement&&e.focus()},100):await l()&&(i=!0)},s=()=>{n.close(),document.body.style.overflow=""},a=e=>{e.target===n&&s()},m=e=>{e.key==="Escape"&&n.open&&s()},f=e=>{(e.metaKey||e.ctrlKey)&&e.key==="k"&&(e.preventDefault(),n.open?s():o())};t.addEventListener("click",o),r.addEventListener("click",s),n.addEventListener("click",a),document.addEventListener("keydown",m),document.addEventListener("keydown",f),document.addEventListener("astro:before-swap",()=>{t.removeEventListener("click",o),r.removeEventListener("click",s),n.removeEventListener("click",a),document.removeEventListener("keydown",m),document.removeEventListener("keydown",f),d=!1},{once:!0})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",u):u();document.addEventListener("astro:page-load",u);</script> <link href="/pagefind/pagefind-ui.css" rel="stylesheet">  </div> </div> </nav> </header>  <main id="main-content" data-pagefind-body class="main-content main-content--wide" data-astro-cid-sckkx6r4>  <div class="blog-post-container" data-astro-cid-wrgicudb> <article class="blog-post" data-astro-cid-wrgicudb> <header class="article-header" data-astro-cid-wrgicudb> <h1 data-astro-cid-wrgicudb>诊断工厂</h1> <div class="article-meta" data-astro-cid-wrgicudb> <a href="https://matklad.github.io" target="_blank" rel="noopener noreferrer" class="source-tag" data-astro-cid-wrgicudb>matklad.github.io</a> <span class="separator" data-astro-cid-wrgicudb>·</span> <time data-astro-cid-wrgicudb>2026年2月16日</time> </div> </header> <!-- 使用清洗后的安全 HTML 内容 --> <div class="article-content app-prose" data-astro-cid-wrgicudb>
<header>
  <h1>Diagnostics Factory</h1>
  <time>Feb 16, 2026</time>
</header>
<p>In
<span><a href="https://matklad.github.io/2025/11/06/error-codes-for-control-flow.html" target="_blank" rel="noopener noreferrer"><em>Error Codes For Control Flow</em></a>,</span>
I explained that Zig’s strongly-typed error codes solve the “handling” half of error management,
leaving “reporting” to the users. Today, I want to describe my personal default approach to
the reporting problem, that is, showing the user a useful error message.</p>
<p>The approach is best described in the negative: <em>avoid</em> thinking about error payloads, and what
the type of error should be. Instead, provide a set of functions for constructing errors.</p>
<p>To give a concrete example, in TigerBeetle’s
<a href="https://github.com/tigerbeetle/tigerbeetle/blob/0.16.73/src/tidy.zig#L54-L188" target="_blank" rel="noopener noreferrer"><code>tidy.zig</code></a>
(a project-specific linting script, another useful meta-pattern), we define errors as follows:</p>

<figure>


<pre><code><span><span>const</span> Errors = <span>struct</span> {</span>
<span>    <span>pub</span> <span>fn</span><span> add_long_line</span>(</span>
<span>        errors: <span>*</span>Errors,</span>
<span>        file: SourceFile,</span>
<span>        line_index: <span>usize</span>,</span>
<span>    ) <span>void</span> { ... }</span>
<span></span>
<span>    <span>pub</span> <span>fn</span><span> add_banned</span>(</span>
<span>        errors: <span>*</span>Errors,</span>
<span>        file: SourceFile,</span>
<span>        offset: <span>usize</span>,</span>
<span>        banned_item: []<span>const</span> <span>u8</span>,</span>
<span>        replacement: []<span>const</span> <span>u8</span>,</span>
<span>    ) <span>void</span> { ... }</span>
<span></span>
<span>    <span>pub</span> <span>fn</span><span> add_dead_declaration</span>(...) <span>void</span> { ... }</span>
<span></span>
<span>    ...</span>
<span>};</span></code></pre>

</figure>
<p>and the call-site looks like this:</p>

<figure>


<pre><code><span><span>fn</span><span> tidy_file</span>(file: SourceFile, errors: <span>*</span>Errors) <span>void</span> {</span>
<span>    <span>// ...</span></span>
<span>    <span>var</span> line_index: <span>usize</span> = <span>0</span>;</span>
<span>    <span>while</span> (lines.next()) <span>|</span>line<span>|</span> : (line_index <span>+=</span> <span>1</span>) {</span>
<span>        <span>const</span> line_length = line_length(line);</span>
<span>        <span>if</span> (line_length &gt; <span>100</span> <span>and</span> <span>!</span>contains_url(line)) {</span>
<span>            errors.add_long_line(file, line_index);</span>
<span>        }</span>
<span>    }</span>
<span>}</span></code></pre>

</figure>
<p>In this case, I collect multiple errors so I don’t return right away. Fail fast would look like
this:</p>

<figure>


<pre><code><span>errors.add_long_line(file, line_index);</span>
<span><span>return</span> <span>error</span>.Tidy;</span></code></pre>

</figure>
<p>Note that the error code is intentionally independent of the specific error produced.</p>
<hr />
<p>Some interesting properties of the solution:</p>
<ul>
<li>
The error representation is a set of constructor functions, the calling code doesn’t care what
<em>actually</em> happens inside. This is why the error factory is my <em>default</em> solution — I don’t have
to figure out up-front what I’ll do with the errors, and I can change my mind later.
</li>
<li>
There’s a natural place to convert information from the form available at the place where we emit
the error to a form useful for the user. In <code>add_banned</code> above, the caller passes in a absolute
offset in a file, and it is resolved to line number and column inside (tip: use <code>line_index</code> for
0-based internal indexes, and <code>line_number</code> for user-visible 1-based ones). Contrast this with a
traditional error as sum-type approach, where there’s a sharp syntactic discontinuity between
constructing a variant directly and calling a helper function.
</li>
<li>
This syntactic uniformity in turn allows easily grepping for all error locations:
<span><code>rg 'errors.add_'</code>.</span>
</li>
<li>
Similarly, there’s one central place that enumerates all possible errors (which is either a
benefit or a drawback).
</li>
</ul>
<p>A less trivial property is that this structure enables polymorphism. In fact, in the <code>tidy.zig</code>
code, there are two different representations of errors. When running the script, errors are
directly emitted to stderr. But when testing it, errors are collected into an in-memory buffer:</p>

<figure>


<pre><code><span><span>pub</span> <span>fn</span><span> add_banned</span>(</span>
<span>    errors: <span>*</span>Errors,</span>
<span>    file: SourceFile,</span>
<span>    offset: <span>usize</span>,</span>
<span>    banned_item: []<span>const</span> <span>u8</span>,</span>
<span>    replacement: []<span>const</span> <span>u8</span>,</span>
<span>) <span>void</span> {</span>
<span>    errors.emit(</span>
<span>        <span>"{s}:{d}: error: {s} is banned, use {s}<span>\n</span>"</span>,</span>
<span>        .{</span>
<span>            file.path, file.line_number(offset),</span>
<span>            banned_item, replacement,</span>
<span>        },</span>
<span>    );</span>
<span>}</span>
<span></span>
<span><span>fn</span><span> emit</span>(</span>
<span>    errors: <span>*</span>Errors,</span>
<span>    <span>comptime</span> fmt: []<span>const</span> <span>u8</span>,</span>
<span>    args: <span>anytype</span>,</span>
<span>) <span>void</span> {</span>
<span>    <span>comptime</span> assert(fmt[fmt.len <span>-</span> <span>1</span>] <span>==</span> <span>'<span>\n</span>'</span>);</span>
<span>    errors.count <span>+=</span> <span>1</span>;</span>
<span>    <span>if</span> (errors.captured) <span>|</span><span>*</span>captured<span>|</span> {</span>
<span>        captured.writer(errors.gpa).print(fmt, args)</span>
<span>            <span>catch</span> <span>@panic</span>(<span>"OOM"</span>);</span>
<span>    } <span>else</span> {</span>
<span>        std.debug.print(fmt, args);</span>
<span>    }</span>
<span>}</span></code></pre>

</figure>
<p>There isn’t a giant <code>union(enum)</code> of all errors, because it’s not needed for the present use-case.</p>
<p>This pattern can be further extended to a full-fledged diagnostics framework with error builders,
spans, ANSI colors and such, but that is tangential to the main idea here: even when “programming in
the small”, it might be a good idea to avoid constructing enums directly, and mandate an
intermediate function call.</p>
<hr />
<p>Two more meta observations here:</p>
<p><em>First</em>, the entire pattern is of course the expression of duality between a sum of two types and a
product of two functions (the visitor pattern)</p>

<figure>


<pre><code><span><span>fn</span> <span>foo</span>() <span>-&gt;</span> <span>Result</span>&lt;T, E&gt;;</span>
<span></span>
<span><span>fn</span> <span>bar</span>(ok: <span>impl</span> <span>FnOnce</span>(T), err: <span>impl</span> <span>FnOnce</span>(E));</span></code></pre>

</figure>

<figure>


<pre><code><span><span>enum</span> <span>Result</span>&lt;T, E&gt; {</span>
<span>    <span>Ok</span>(T),</span>
<span>    <span>Err</span>(E),</span>
<span>}</span>
<span></span>
<span><span>trait</span> <span>Result</span>&lt;T, E&gt; {</span>
<span>    <span>fn</span> <span>ok</span>(<span>self</span>, T);</span>
<span>    <span>fn</span> <span>err</span>(<span>self</span>, E);</span>
<span>}</span></code></pre>

</figure>
<p><em>Second</em>, every abstraction is a thin film separating two large bodies of code. Any interface has
two sides, the familiar one presented to the user, and the other, hidden one, presented to the
implementor. Often, default language machinery pushes you towards using the same construct for both
but that can be suboptimal. It’s natural for the user and the provider of the abstraction to
disagree on the optimal interface, and to evolve independently. Using a single big enum for errors
couples error emitting and error reporting code, as they have to meet in the middle. In contrast,
the factory solution is optimal for producer (they literally just pass whatever they already have on
hand, without any extra massaging of data), and is flexible for consumer(s).</p>
</div> <footer class="article-footer" data-astro-cid-wrgicudb> <div class="action-row" data-astro-cid-wrgicudb> <a href="https://matklad.github.io/2026/02/16/diagnostics-factory.html" target="_blank" rel="noopener noreferrer" class="read-original-btn" data-astro-cid-wrgicudb>
阅读原文 ↗
</a> </div> <div class="back-to-list" data-astro-cid-wrgicudb> <a href="/reading-list" class="back-link" data-astro-cid-wrgicudb>← 返回订阅列表</a> </div> </footer> </article> </div>  </main> <footer class="site-footer" aria-label="Site footer" data-astro-cid-sz7xmlte> <div class="footer-content" data-astro-cid-sz7xmlte> <p class="footer-text" data-astro-cid-sz7xmlte>
&copy; 2026 AstroBlog
</p> <p class="footer-text" data-astro-cid-sz7xmlte>
Built with  <a href="https://astro.build/" target="_blank" rel="noopener noreferrer" class="footer-link" data-astro-cid-sz7xmlte>
Astro
</a> </p> </div> </footer>  </body></html> 